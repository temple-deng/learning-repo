# 第 10 章 存储和文件结构

## 10.2 磁盘和闪存

### 10.2.1 磁盘的物理特性

磁盘的每一个盘片是扁平的圆盘。它的两个表面都覆盖着磁性物质，信息就记录在表面上。盘片由硬金属
或玻璃制成。     

通过反转磁性物质磁化的方向，**读写头**将信息磁化存储到扇区中。    

所有磁道的读写头安装在一个称为**磁盘臂**的单独装置上，并且一起移动。因为所有盘片上的读写头一起移动，
所以当某一个盘片的读写头在第 i 条磁道上时，所有其他盘片的读写头也都在各自盘片的第 i 条磁道上。
因此，所有盘片的第 i 条磁道合在一起称为第 i 个**柱面**。      

**磁盘控制器**作为计算机系统和实际的磁盘驱动器硬件之间的接口。在现代磁盘系统中，磁盘控制器在磁盘驱动
单元内部实现。它接受高层次的读写扇区的命令，然后开始动作，如移动磁盘臂到正确的磁道，并实际地
读写数据。磁盘控制器为它所写的每个扇区附加**检验和**，检验和是从写到扇区中的数据计算得到的。
当读取一个扇区时，磁盘控制器用读到的数据再一次计算校验和，并且把它与存储的校验和做比较。如果数据
被破坏，则新计算出的校验和与存储的校验和不一致的可能性就很高。如果发生了这样的错误，磁盘控制器
就会重读几次；如果错误继续发生，磁盘控制器就会发出一个读操作失败的信号。     

磁盘通过一个高速互联通道连接到计算机系统，有大量的通用接口用于将磁盘连接到计算机，现今一般
使用的接口是：1. SATA; 2. SCSI; 3. SAS(serial attached SCSI) 4. 光纤通道接口     

磁盘通常可以通过电缆直接与计算机系统的磁盘接口相连，也可以放置到远端并通过高速网络与磁盘
控制控制器相连（怎么连的，磁盘上有网口吗）。在**存储区域网**(Storage Area Network, SAN)
体系结构中，大量的磁盘通过高速网络与许多计算机服务器相连。通常磁盘采用 RAID 技术进行本地化组织。
尽管可能被网络分开，计算机和磁盘子系统继续通过 SCSI、SAS 和光纤通道接口互相通信。   

**网络附加存储**(Network Attached Storage, NAS)由 SAN 发展而来。NAS 很像 SAN，但是它通过
使用网络文件系统协议提供文件系统接口，而不是看似一张大磁盘的网络存储器。      

### 10.2.2 磁盘性能的度量

磁盘质量的主要度量指标是容量、访问时间、数据传输率和可靠性。    

**访问时间**是从发出读写请求到数据开始传输之间的时间。为了访问磁盘上指定扇区的数据，磁盘臂首先
必须移动，以定位到正确的磁道，然后等待磁盘旋转（话说不能同时开始嘛，好像并不冲突啊）。     

访问时间是寻道时间和旋转等待时间的总和，范围在8~20毫秒之间。一旦待访问数据的第一个扇区来到
读写头下方，数据传输就开始了。**数据传输率**是从磁盘获得数据的速率。    

### 10.2.3 磁盘块访问的优化

磁盘 I/O 请求是由文件系统和大多数操作系统具有的虚拟内存管理器产生的。每个请求指定了要访问
的磁盘地址，这个地址是以块号的形式提供的。一个**块**是一个逻辑单元，它包含固定数目的连续扇区。
块大小在512字节到几KB之间。数据在磁盘和主存储器之间以块为单位传输。      

为了提高访问块的速度，产生了许多技术：    

+ **缓冲**。从磁盘读取的块暂时存储在内存缓冲区中，以满足将来的要求。缓冲通过操作系统和数据库系统
共同运作。
+ **预读**。当一个磁盘块被访问时，相同磁道的连续块也被读入内存缓冲区，即便没有针对这些块
的即将来临的请求。但是，预读只对顺序访问有效果，对随机访问并不是很有用。
+ **调度**。磁盘臂调度算法。
+ **文件组织**。为了减少块访问时间，我们可以按照与预期的数据访问方式最接近的方式来组织磁盘上
的块。例如，如果我们预计一个文件将被顺序地访问，那么理想情况下我们应该使文件所有块存储在连续的
相邻柱面上。     
+ **非易失性写缓冲区**。因为内存中的内容在发生电源故障时将全部丢失，所以关于数据库更新的信息必须
记录到磁盘上，这样才能在系统崩溃时得以保存。因此，更新操作密集的数据库应用的性能，高度依赖于
磁盘写操作的速度。我们可以使用非易失性RAM(NV-RAM)大幅度地加速写磁盘的操作。NV-RAM 的内容
在发生电源故障时不会丢失。一种实现NV-RAM的常用方法是使用有备用电池的 RAM。其思想是，当数据库
系统请求往磁盘上写一个块时，磁盘控制器将这个块写到 NV-RAM 缓冲区中，然后立即通知操作系统写
操作已经完成。当磁盘上没有其他请求时，或者当 NV-RAM缓冲区满时，磁盘控制器将
这些数据写到磁盘上相应的目标地址处。
+ **日志磁盘**。减少写等待时间的另一种方法是使用日志磁盘，即一种专门用于写顺序日志的磁盘，这和
非易失性RAM 缓冲区的使用非常相似。对日志磁盘的所有访问都是顺序的，这从根本上消除了寻道时间，
并且一次可以写几个连续的块，使得写日志磁盘比随机的写要快许多倍。和前面一样，数据也必须写到
他们在磁盘上的实际位置，但是数据库系统不需要等待这种写操作的完成，日志磁盘会在以后完成写操作。
进一步说，日志磁盘可以为了最少化磁盘臂的移动而重排写操作的顺序。如果系统在实际磁盘写操作
完成以前崩溃，在系统恢复后，系统可以读取日志磁盘，找到那些还没有完成的写操作并将它们完成。     

### 10.2.4 快闪存储

一共有两种快闪存储器，即 NOR 快闪和 NAND 快闪。NOR 快闪允许随机访问闪存中的单个字，并且拥有和
主存和媲美的读取速度。而 NAND 快闪和 NOR 快闪不同，它的读取需要将整个数据页从 NAND 快闪取到
主存中，该数据页通常包括 512~4096 个字节。但是 NAND 快闪比 NOR 的便宜，而且容量大。     

与磁盘相比，闪存可以提供更快的随机存取：一个数据页，从闪存中可以在越1~2微妙内检测到，而磁盘
上一个随机访问则需要5~10毫秒。     

闪存的写入稍有些复杂。写一个闪存页面通常需要几微妙。然而，一旦写入，闪存的页面不能直接覆盖。它
必须先擦除然后再重写。一次擦除操作可以在多个页面执行，称为**擦除块**，这种操作需时约1~2毫秒。
一个擦除块的大小通常明显比存储系统的块大很多。此外，对一个闪存页可以擦除多少次存在限制。一旦
到达此限制，在存储位就可能发生错误。     


## 10.5 文件组织

一个数据库被映射到多个不同的文件，这些文件由底层的操作系统来维护。这些文件永久地存在于磁盘上。
一个文件在逻辑上组织成为记录的一个序列。这些记录是映射到磁盘块上。      

每个文件分成定长的存储单元，称为**块**（貌似这个块和磁盘块不是一个概念）。块是存储分配
和数据传输的基本单元。大多数数据库默认使用4~8 KB的块大小，但是当创建数据库实例时，许多
数据库允许指定块大小。     

一个块可能包括很多条记录。我们假定没有记录会比块大。此外，我们需要要求每条记录包含在单个块中，
换句话说，没有记录时部分包含在一个块中，部分包含在另一个块中。这个限制简化并加速数据项访问。    

在关系数据库中，不同关系的元祖通常具有不同的大小。把数据库映射到文件的一种方法是使用多个文件，
在任意一个文件中只存储一个固定的长度的记录。另一种选择是构造自己的文件，使之能够容纳多种长度
的记录。然而，定长记录文件比变长记录文件更容易实现。     

### 10.5.1 定长记录

例如，让我们考虑由大学数据库中的 instructor 记录组成的一个文件。文件中每个记录定义（使用
伪代码）如下：   

```
type instructor = record
  ID varchar(5);
  name varchar(20);
  dept_name varchar(20);
  salary numeric(8, 2);
end
```    

假设每个字符占 1 个字节，numeric(8, 2) 占 8 个字节。假设我们为每个属性 ID、name 和
dept_name 分配可以容纳的最大字节数，而不是分配可变的字节数。于是 instructor 记录占 53
个字节。一个简单的方法是使用前 53 个字节来存储第一个记录，接下来的 53 个字节存储第二条
记录，以此类推。然而这种方面有两个问题：   

+ 除非块的大小恰好是 53 的倍数，否则一些记录会跨越块的边界，即一条记录的一部分存储在一个
块中，而另一部分存储在另一个块中。于是，读写这样的一条记录需要两次块访问。    
+ 从这个结构中删除一条记录十分困难。删除的记录所占据的空间必须由文件中的其他记录来填充，
或者我们必须用一种方法标记删除的记录使得它可以被忽略。    

第一个问题，我们可以在一个块中只分配他能完整容纳下的最大的记录数。每个块中余下的字节就不
使用了。   

第二个问题，将文件的最后一条记录移到被删记录所占据空间中可能容易一些。    

移动记录以占据被删记录所释放空间的做法并不理想，因为这样做需要额外的块访问操作。由于插入
操作通常比删除操作更频繁，因此让已被删除的记录占据的空间空着，一直等到随后进行的插入操作
重用这个空间，这样做是可以接收的。仅在被删记录上做一个标记是不够的，因为当插入操作执行时，
找到这个可用空间十分困难。因此我们需要引入额外的结构。   

在文件的开始处，我们分配一定数量的字节作为 **文件头**。文件头将包含有关文件中的各种信息。
到目前为止，我们需要在文件头中存储的只有内容被删除的第一个记录的地址。我们用这第一个记录
来存储第二个可用记录的地址，依次类推。我们可以直观地把这些存储的地址看做指针。于是，被删除
的记录形成了一条链表，经常称为 **空间链表**。    

### 10.5.2 变长记录

变长记录以下面几种方式出现在数据库系统中：    

+ 多种记录类型在一个文件中存储。
+ 允许一个或多个字段是变长的记录类型。
+ 允许可重复字段的记录类型，例如数组或多重集合。   

实现变长记录存在不同的技术，任何这样的技术都必须解决两个不同的问题：   

+ 如何描述一条记录，使得单个属性可以轻松地抽取
+ 在块中如何存储变长记录，使得块中的记录可以轻松地抽取     

