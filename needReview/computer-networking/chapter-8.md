# 第 8 章 计算机网络中的安全

## 8.1 什么是网络安全

安全通信具有下列所需要的特性。     

+ 机密性。仅有发送方和希望的接收方能够理解传输报文的内容。因为窃听者可以截获报文，这必须要求报文在一定
程度上进行**加密**。
+ 报文完整性。通信的内容在传输过程中未被改变——或者恶意篡改或者意外改动。
+ 端点鉴别。发送方和接收方都应该能证实通信过程所涉及的另一方，以确信通信的另一方确实具有它们所声称的身份。
+ 运行安全性。防火墙和入侵检测系统等运行设备正被用于反制对机构网络的工具。防火墙位于机构网络和公共网络之间，
控制接入和来自网络的分组。入侵检测系统执行“深度分组检查”任务，向网络管理员发出有关可疑活动的警告。      

## 8.2 密码学的原则

对称密钥系统的话就是 DES、3DES、AES，公开密钥系统的话就是 RSA。    


## 8.3 报文完整性和数字签名

### 8.3.1 密码散列函数

散列函数以 m 为输入，并计算得到一个称为散列的固定长度的字符串 H(m)。因特网校验和和 CRC 都满足这个定义。
密码散列函数要求具有下列附加的性质：    

+ 找到任意两个不同的报文 x 和 y 使得 H(x)=H(y)，在计算上是不可能的。    

MD5 散列算法通过 4 步过程计算得到一个 128 比特的散列。第二个算法是安全散列算法 SHA-1，生成一个 160 比特
的报文摘要。     

### 8.3.2 报文鉴别码

光有散列函数的话挡不住中间人攻击。为了执行报文完整性，除了使用密码散列函数，通信双方还需要共享密钥 s。
它被称为**鉴别密钥**。使用这个密钥，报文完整性能执行如下：   

1. A 生成报文 m，用 s 级联 m 生成 m + s，然后计算 H(m+s)，H(m+s) 被称为**报文鉴别码**（Message Authentication Code, MAC）
2. A 把 MAC 附到报文中发送。
3. B 收到报文，计算 H(m+s)     

## 8.6 SSL

### 8.6.1 宏观描述

先从一个类 SSL 开始介绍，类 SSL 和 SSL 都具有三个阶段：握手、密钥导出和数据传输。     

1. 握手，简单来说，在 SSL 第一次握手后，C 生成一个主密钥 MS，然后用 S 的公钥加密发给 S。    
2. 密钥导出，原则上来说 MS 可以用作后面加密和数据完整性检查使用的密钥的，但是对于 S 和 C 而言，
使用不同的密码密钥，并且对于加密和完整性检查也使用不同的密钥，通常认为更安全，因此会使用 MS 生成 4 个密钥：
  + E<sub>C</sub>，用于从 C 发送到 S 的数据的会话加密密钥
  + M<sub>C</sub>，用于 C 发送到 S 的数据的会话的 MAC 密钥
  + E<sub>S</sub>，用于从 S 发送到 C 的会话加密密钥
  + M<sub>S</sub>，用于从 S 发送端 C 的数据的会话 MAC 密钥      

SSL 将数据流分割成记录，对每个记录附加一个 MAC 用于完整性检查，然后加密该 “记录 + MAC”。    

虽然这种方法几经周折，但它为整个报文流提供数据完整性时仍未达到无懈可击。特别是，假设 Trudy 是一名
“中间人”，并且有在 Server 和 Client 之间发送的 TCP 报文段流中插入、删除和代替报文段的能力。例如，
Trudy 能够捕获 Client 发送的两个报文段，颠倒这两个报文段的次序，调整 TCP 报文段的序号，然后
将这两个次序颠倒的报文段发送到 Server。这样的话，Server 收到的报文段的就是错误的。    

解决方案的话就是使用序号。SSL 采用如下的方式。Client 维护一个序号计数器，计数器从 0 开始，Client 每
发送的一个 SSL 记录它都增加1。Client 并不实际在记录中包括一个序号，但当他计算 MAC 时，他把该序号
包括在 MAC 的计算中。所以该 MAC 现在是数据加 MAC 密钥 M<sub>C</sub> 加当前序号的散列。     

SSL 记录的格式如下，类型字段指出了该字段是握手报文还是包含应用数据的报文，它也用于关闭 SSL 连接。    

@TODO 此处该有图。      


### 8.6.2 更完整的描述

+ **1. SSL 握手**     

真正的 SSL 握手的步骤如下：    

1. 客户发送它支持的密码算法的列表，连同一个客户的不重数返回给客户。
2. 从该列表中，服务器选择一种对称算法（例如 AES）、一种公钥算法（例如具有特定密钥长度的 RSA）和一种
MAC 算法。它把它的选择以及证书和一个服务器不重数返回给客户。
3. 客户验证该证书，提取服务器的公钥，生成一个**前主密钥**（Pre-Master Secret, PMS），用服务器的公钥
加密该 PMS，并用加密的 PMS 发送给服务器。
4. 使用相同的密钥导出函数（就像 SSL 标准定义的那样），客户和服务器独立地从 PMS 和不重数中计算出**主密钥**（Master Secret, MS）。然后该 MS 被切片以生成两个密码和两个 MAC 密钥。此外，当选择的对称密码应用于 CBC，则两个
初始化向量（Initialization Vector, IV）也从该 MS 获得，这两个 IV 分别用于该连接的两端。
自此以后，客户和服务器之间发送的所有报文均被加密和鉴别。
5. 客户发送所有握手报文的一个 MAC。（话说这个是什么时候发的，如果随 PMS 一起发送，那是无法加密的，但是如果
不一起发送，那应该在一个服务器响应后才发送把）
6. 服务器发送所有握手报文的一个 MAC。     

+ **2. 连接关闭**      

SSL 在类型字段会指出该记录是否用于终止该会话。     

## 8.7 网络层安全性：IPsec 和虚拟专用网      

IP 安全协议更常被称为 IPsec。IPsec 为任意两个网络层实体之间的 IP 数据报提供了安全。许多机构使用
IPsec 创建了运行在安全因特网之上的**虚拟专用网**（Virtual private network, VPN）。      

### 8.7.2 AH 协议和 ESP 协议

在 IPsec 协议族中，有两个主要协议：**鉴别首部**（Authentication Header, AH）协议和**封装安全性载荷**（ESP）
协议。当某源 IPsec 实体向一个目的实体发送安全数据报时，它可以使用AH协议和 ESP 协议来做到。AH 协议
提供源鉴别和数据完整性服务，但不提供机密性服务。ESP 协议提供了源鉴别、数据完整性和机密性服务。     

### 8.7.3 安全关联

在从源实体向目的实体发送 IPsec 数据报之前，源和目的实体创建了一个网络层的逻辑连接。这个逻辑连接称为**安全管理**（Security Association, AS）。一个SA 是一个单工逻辑连接；也就是说，它是从源到目的地单向的。如果两个
实体要互相发送安全数据报，则需创建两个 SA，每个方向一个。      

通常来说实现了 IPsec 的路由器和主机都会维护关于 SA 的状态信息，包括：    

+ SA 的 32比特的标识符，称为**安全参数索引**（Security Parameter Index, SPI）。
+ SA 的初始接口和 SA 的目的接口。
+ 将使用的加密类型
+ 加密密钥
+ 完整性检测的类型
+ 鉴别密钥       

一个 IPsec 实体在它的**安全关联数据库**（Security Association Database, SAD）中存储其所有 SA
的状态信息，SAD 是实体操作系统内核的一个数据结构。     

### 8.7.4 IPsec数据报

IPsec 有两种不同的分组形式，一种用于所谓的**隧道模式**，一种是**运输模式**。本节主要关注隧道模式。    

IPsec 数据报格式如下：    

@TODO 此处该有图。     

下面是一个源主机的第一跳路由器收到源主机的普通 IPv4 数据报的处理流程（话说这里没讲建立连接的阶段）：    

+ 在初始 IPv4 数据报后面附加一个“ESP 尾部”字段。
+ 使用算法和 SA 规定的密钥加密该结果。
+ 在加密量前面附加一个“ESP 首部”字段，得到被称为“enchilada"的包
+ 使用算法和 SA 规定的密钥生成一个覆盖 enchilada 的鉴别 MAC。
+ 将 MAC 附到 enchilada 后形成载荷。
+ 最后，生成一个具有所有经典 IPv4 首部字段的全新 IP 首部，将首部附加到载荷之前。       

首先需要注意的是源 IP 首部中的地址是直接通信的两个主机的 IP 地址，而新的 IP 首部中的地址应该是两个
主机通信的第一跳路由器的 IP 地址（即接入因特网设备的地址）。其次新首部中的协议号为 50，指示这是
一个使用 ESP 协议的 IPsec 数据报。     

### 8.7.5 IKE：IPsec 中的密钥管理

大型的、地理上分散的部署要求一个自动的机制来生成 SA。IPsec 使用**因特网密钥交换**（Internet Key Exchange, IKE）协议来从事这项工作。     

IKE 和 SSL 中的握手类似。每个 IPsec 实体具有一个证书，该证书包括了该实体的公开密钥。如同使用 SSL 一样，
IKE 协议让两个实体交换证书，协商鉴别和加密算法，并安全地交换用于在 IPsec SA 中生成会话密钥的密钥材料。与
SSL 不同的是，IKE 应用两个阶段来执行这些任务。      

具体过程没看懂。。          