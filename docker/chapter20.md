# 第 20 章 高级网络功能

<!-- TOC -->

- [第 20 章 高级网络功能](#第-20-章-高级网络功能)
  - [20.1 启动与配置参数](#201-启动与配置参数)
    - [20.1.1 网络启动过程](#2011-网络启动过程)
    - [20.1.2 网络相关参数](#2012-网络相关参数)
  - [20.2 配置容器 DNS 和主机名](#202-配置容器-dns-和主机名)
    - [20.2.1 相关配置文件](#2021-相关配置文件)
    - [20.2.2 容器内修改配置文件](#2022-容器内修改配置文件)
    - [20.2.3 通过参数指定](#2023-通过参数指定)
  - [20.3 容器访问控制](#203-容器访问控制)
    - [20.3.1 容器访问外部网络](#2031-容器访问外部网络)
    - [20.3.2 容器之间访问](#2032-容器之间访问)
  - [20.4 映射容器端口到宿主主机的实现](#204-映射容器端口到宿主主机的实现)

<!-- /TOC -->

## 20.1 启动与配置参数

### 20.1.1 网络启动过程

Docker 服务启动时会首先在主机上自动创建一个 docker0 虚拟网桥，实际上是一个 Linux 网桥。网桥
可以理解为一个软件交换机，负责挂载其上的借口之间进行包转发。    

同时，Docker 随机分配一个本地未占用的私有网段中的一个地址给 docker0 接口，比如典型的 172.17.0.0/16
网段，掩码为 255.255.0.0。此后启动的容器内的网口也会自动分配一个该网段的地址。    

当创建一个 Docker 容器的时候，同时会创建一对 veth pair 互联接口。当向任一个接口发送包时，另外
一个接口自动收到相同的包。互联接口的一端位于容器内，即 eth0；另一端在本地并被挂载到 docker0
网桥，名称以 veth 开头。通过这种方式，主机可以与容器通信，容器也可以相互通信。这样一来，Docker
就创建了在主机和所有容器之间一个虚拟共享网络。    

### 20.1.2 网络相关参数

下面是与 Docker 网络相关的命令参数。其中部分命令选项只有在 Docker服务启动的时候才能配置，修改后
重启生效，包括:    

- `-b BRIDGE` or `--bridge=BRIDGE`: 指定容器挂载的网桥；
- `--bip=CIDR`: 定制 docker0 的掩码；
- `-H SOCKET...` or `--host=SOCKET...`: Docker 服务端接收命令的通道（什么意思）
- `--icc=true|false`: 是否支持容器之间进行通信
- `--ip-forward=true|false`: 启用 net.ipv4.ip_forward，即打开转发功能；
- `--iptables=true|false`: 禁止 Docker 添加 iptables 规则；
- `mtu=BYTES`: 容器网络中的 MTU     

下面的命令即可以在启动服务时指定，也可以 Docker 容器启动时候指定。在 Docker 服务启动的时候会成为
默认值，后续执行该命令时可以覆盖设置的默认值：   

- `--dns=IP_ADDRESS`: 使用指定的 DNS 服务器
- `--dns-opt=""`: 指定 DNS 选项
- `--dns-search=DOMAIN`: 指定 DNS 搜索域    

还有些选项只能在 `docker run` 命令执行时使用，因为它针对容器的配置：   

- `-h HOSTNAME` or `--hostname=HOSTNAME`: 配置容器主机名
- `-ip=""`: 指定容器内接口的 IP 地址
- `--link=CONTAINER_NAME:ALIAS`: 添加到另一个容器的连接
- `--net=bridge|none|container:NAME_or_ID|host|user_defined_network`: 配置容器的桥接模式
- `--network-alias`: 容器在网络中的别名
- `-p SPEC` or `--publish=SPEC`: 映射容器端口到宿主主机
- `-P` or `--publish-all=true|false`: 映射容器所有端口到宿主主机

其中，--net 选项支持以下五种模式：    

- bridge: 默认配置。为容器创建独立的网络命名空间，分配网卡、IP 地址等网络配置，并通过 veth
接口对容器挂载到一个虚拟网桥上
- none: 为容器创建独立的网络命名空间，但不进行网络配置，即容器内没有创建网卡、IP 地址等
- container:NAME_or_ID: 新创建的容器共享指定的已存在容器的网络命名空间，两个容器内的网络配置
共享，但其他资源（如进程空间、文件系统等）还是相互隔离的
- host: 不为容器创建独立的网络命名空间，容器内看到的网络配置（网卡信息、路由表、Iptables 规则等）
均与主机上的保持一致。
- user_defined_network: 用户自行用 network 相关命令创建已网络，同一个网络内的容器彼此可见

## 20.2 配置容器 DNS 和主机名

Docker 服务启动后会默认启用一个内嵌的 DNS 服务，来自动解析同一个网络中的容器主机名和地址，如果
无法解析，则通过容器内的 DNS 相关配置进行解析。用户可以通过命令选项自定义容器的主机名和 DNS 配置。   

### 20.2.1 相关配置文件

容器中主机名的 DNS 配置信息可以通过三个系统配置文件来管理：/etc/resolv.conf, /etc/hostname
和 /etc/hosts。    

Docker 启动容器时，会从宿主机复制 /etc/resolv.conf 文件，并删除掉其中无法连接到的 DNS 服务器。    

/etc/hosts 文件中默认只记录了容器自身的地址和名称。/etc/hostname 文件则记录了容器的主机名。    

### 20.2.2 容器内修改配置文件

容器运行时，可以在运行中的容器里直接编辑 /etc/hosts, /etc/hostname 和 /etc/resolv.conf
文件。但是这些修改是临时的，只在运行的容器中保留，容器终止或重启后并不会被保存下来，也不会被
docker commit 提交。   

### 20.2.3 通过参数指定

如果用户想要自定义容器的配置，可以在创建或启动容器时利用下面的参数指定：   

- 指定主机名 -h HOSTNAME: 设定容器的主机名。容器主机名会被写到容器内的 /etc/hostname 和
/etc/hosts。但这个主机名只有容器内能看到，在容器外部则看不到
- `--link=CONTAINER_NAME:ALIAS`: 记录其他容器主机名。在创建容器的时候，添加一个所连接容器的
主机名到容器内 /etc/hosts 文件中。这样，新建容器可以直接使用主机名与所连接容器通信
- `--dns=IP_ADDRESS`: 指定 DNS 服务器。添加 DNS 服务器到容器的 /etc/resolv.conf 中，容器
会用指定的服务器来解析所有不在 /etc/hosts 中的主机名
- `--dns-option list`: 指定 DNS 相关选项
- `--dns-search=DOMAIN`: 指定 DNS 搜索域。设定容器的搜索域，当设定搜索域为 .example.com
时，在搜索一个名为 host 的主机时，DNS 不仅搜索 host，还会搜索 host.example.com

## 20.3 容器访问控制

容器的访问控制主要通过 Linux 上的 iptables 防火墙软件来进行管理和实现。    

### 20.3.1 容器访问外部网络

容器要想通过宿主机访问到外部网络，则需要宿主机进行辅助转发。    

### 20.3.2 容器之间访问

容器之间相互访问需要两方面的支持：   

- 网络拓扑是否已经连通。默认情况下，所有容器都会连接到 docker0 网桥上，这意味着默认情况下拓扑
是互通的
- 本地系统的防火墙软件 iptables 是否允许访问通过。这取决于防火墙的默认规则是允许（大部分情况）
还是禁止

1. 访问所有端口：当启动 Docker 服务时候，默认会添加一条“允许”转发策略到 iptables 的 FORWARD
链上。
2. 访问指定端口：在通过 -icc=false 禁止容器间相互访问后，仍可以通过 --link=CONTAINER_NAME:ALIAS
选项来允许访问指定容器的开发端口

## 20.4 映射容器端口到宿主主机的实现

默认情况下，容器可以主动访问到外部网络的连接，但是外部网络无法访问到容器。   