# 第 20 章 高级网络功能

<!-- TOC -->

- [第 20 章 高级网络功能](#第-20-章-高级网络功能)
  - [20.1 启动与配置参数](#201-启动与配置参数)
    - [20.1.1 网络启动过程](#2011-网络启动过程)
    - [20.1.2 网络相关参数](#2012-网络相关参数)
  - [20.2 配置容器 DNS 和主机名](#202-配置容器-dns-和主机名)
    - [20.2.1 相关配置文件](#2021-相关配置文件)
    - [20.2.2 容器内修改配置文件](#2022-容器内修改配置文件)
    - [20.2.3 通过参数指定](#2023-通过参数指定)
  - [20.3 容器访问控制](#203-容器访问控制)
    - [20.3.1 容器访问外部网络](#2031-容器访问外部网络)
    - [20.3.2 容器之间访问](#2032-容器之间访问)
  - [20.4 映射容器端口到宿主主机的实现](#204-映射容器端口到宿主主机的实现)
    - [20.4.1 容器访问外部实现](#2041-容器访问外部实现)
    - [20.4.2 外部访问容器实现](#2042-外部访问容器实现)
  - [20.5 配置容器网桥](#205-配置容器网桥)
- [第 21 章 libnetwork 插件化网络功能](#第-21-章-libnetwork-插件化网络功能)
  - [21.1 容器网络模型](#211-容器网络模型)
  - [21.2 Docker 网络命令](#212-docker-网络命令)
    - [21.2.1 创建网络](#2121-创建网络)
    - [21.2.2 接入网络](#2122-接入网络)
  - [21.3 构建跨主机容器网络](#213-构建跨主机容器网络)
    - [21.3.1 配置网络信息管理数据库](#2131-配置网络信息管理数据库)
    - [21.3.2 配置 Docker 主机](#2132-配置-docker-主机)
    - [21.3.3 创建网络](#2133-创建网络)

<!-- /TOC -->

## 20.1 启动与配置参数

### 20.1.1 网络启动过程

Docker 服务启动时会首先在主机上自动创建一个 docker0 虚拟网桥，实际上是一个 Linux 网桥。网桥
可以理解为一个软件交换机，负责挂载其上的借口之间进行包转发。    

同时，Docker 随机分配一个本地未占用的私有网段中的一个地址给 docker0 接口，比如典型的 172.17.0.0/16
网段，掩码为 255.255.0.0。此后启动的容器内的网口也会自动分配一个该网段的地址。    

当创建一个 Docker 容器的时候，同时会创建一对 veth pair 互联接口。当向任一个接口发送包时，另外
一个接口自动收到相同的包。互联接口的一端位于容器内，即 eth0；另一端在本地并被挂载到 docker0
网桥，名称以 veth 开头。通过这种方式，主机可以与容器通信，容器也可以相互通信。这样一来，Docker
就创建了在主机和所有容器之间一个虚拟共享网络。    

@TODO:

### 20.1.2 网络相关参数

下面是与 Docker 网络相关的命令参数。其中部分命令选项只有在 Docker服务启动的时候才能配置，修改后
重启生效，包括:    

- `-b BRIDGE` or `--bridge=BRIDGE`: 指定容器挂载的网桥；
- `--bip=CIDR`: 定制 docker0 的掩码；
- `-H SOCKET...` or `--host=SOCKET...`: Docker 服务端接收命令的通道（什么意思）
- `--icc=true|false`: 是否支持容器之间进行通信
- `--ip-forward=true|false`: 启用 net.ipv4.ip_forward，即打开转发功能；
- `--iptables=true|false`: 禁止 Docker 添加 iptables 规则；
- `mtu=BYTES`: 容器网络中的 MTU     

下面的命令即可以在启动服务时指定，也可以 Docker 容器启动时候指定。在 Docker 服务启动的时候会成为
默认值，后续执行该命令时可以覆盖设置的默认值：   

- `--dns=IP_ADDRESS`: 使用指定的 DNS 服务器
- `--dns-opt=""`: 指定 DNS 选项
- `--dns-search=DOMAIN`: 指定 DNS 搜索域    

还有些选项只能在 `docker run` 命令执行时使用，因为它针对容器的配置：   

- `-h HOSTNAME` or `--hostname=HOSTNAME`: 配置容器主机名
- `-ip=""`: 指定容器内接口的 IP 地址
- `--link=CONTAINER_NAME:ALIAS`: 添加到另一个容器的连接
- `--net=bridge|none|container:NAME_or_ID|host|user_defined_network`: 配置容器的桥接模式
- `--network-alias`: 容器在网络中的别名
- `-p SPEC` or `--publish=SPEC`: 映射容器端口到宿主主机
- `-P` or `--publish-all=true|false`: 映射容器所有端口到宿主主机

其中，--net 选项支持以下五种模式：    

- bridge: 默认配置。为容器创建独立的网络命名空间，分配网卡、IP 地址等网络配置，并通过 veth
接口对容器挂载到一个虚拟网桥上
- none: 为容器创建独立的网络命名空间，但不进行网络配置，即容器内没有创建网卡、IP 地址等
- container:NAME_or_ID: 新创建的容器共享指定的已存在容器的网络命名空间，两个容器内的网络配置
共享，但其他资源（如进程空间、文件系统等）还是相互隔离的
- host: 不为容器创建独立的网络命名空间，容器内看到的网络配置（网卡信息、路由表、Iptables 规则等）
均与主机上的保持一致。
- user_defined_network: 用户自行用 network 相关命令创建已网络，同一个网络内的容器彼此可见

## 20.2 配置容器 DNS 和主机名

Docker 服务启动后会默认启用一个内嵌的 DNS 服务，来自动解析同一个网络中的容器主机名和地址，如果
无法解析，则通过容器内的 DNS 相关配置进行解析。用户可以通过命令选项自定义容器的主机名和 DNS 配置。   

### 20.2.1 相关配置文件

容器中主机名的 DNS 配置信息可以通过三个系统配置文件来管理：/etc/resolv.conf, /etc/hostname
和 /etc/hosts。    

Docker 启动容器时，会从宿主机复制 /etc/resolv.conf 文件，并删除掉其中无法连接到的 DNS 服务器。    

/etc/hosts 文件中默认只记录了容器自身的地址和名称。/etc/hostname 文件则记录了容器的主机名。    

### 20.2.2 容器内修改配置文件

容器运行时，可以在运行中的容器里直接编辑 /etc/hosts, /etc/hostname 和 /etc/resolv.conf
文件。但是这些修改是临时的，只在运行的容器中保留，容器终止或重启后并不会被保存下来，也不会被
docker commit 提交。   

### 20.2.3 通过参数指定

如果用户想要自定义容器的配置，可以在创建或启动容器时利用下面的参数指定：   

- 指定主机名 -h HOSTNAME: 设定容器的主机名。容器主机名会被写到容器内的 /etc/hostname 和
/etc/hosts。但这个主机名只有容器内能看到，在容器外部则看不到
- `--link=CONTAINER_NAME:ALIAS`: 记录其他容器主机名。在创建容器的时候，添加一个所连接容器的
主机名到容器内 /etc/hosts 文件中。这样，新建容器可以直接使用主机名与所连接容器通信
- `--dns=IP_ADDRESS`: 指定 DNS 服务器。添加 DNS 服务器到容器的 /etc/resolv.conf 中，容器
会用指定的服务器来解析所有不在 /etc/hosts 中的主机名
- `--dns-option list`: 指定 DNS 相关选项
- `--dns-search=DOMAIN`: 指定 DNS 搜索域。设定容器的搜索域，当设定搜索域为 .example.com
时，在搜索一个名为 host 的主机时，DNS 不仅搜索 host，还会搜索 host.example.com

## 20.3 容器访问控制

容器的访问控制主要通过 Linux 上的 iptables 防火墙软件来进行管理和实现。    

### 20.3.1 容器访问外部网络

容器要想通过宿主机访问到外部网络，则需要宿主机进行辅助转发。    

首先，我们知道在容器中是可以使用包管理系统安装软件的，而且使用 curl 也是能请求外部的网页的，
那还是说明容器是可以访问外部网络的。   

### 20.3.2 容器之间访问

容器之间相互访问需要两方面的支持：   

- 网络拓扑是否已经连通。默认情况下，所有容器都会连接到 docker0 网桥上，这意味着默认情况下拓扑
是互通的
- 本地系统的防火墙软件 iptables 是否允许访问通过。这取决于防火墙的默认规则是允许（大部分情况）
还是禁止

下面分两种情况介绍容器间的访问：   

1. 访问所有端口   

当启动 Docker 服务时候，默认会添加一条“允许”转发策略到 iptables 的 FORWARD链上。通过配置
--icc=true|false（默认值为 true）参数可以控制默认的策略。    

为了安全考虑，可以在 Docker 配置文件中配置 DOCKER_OPTS＝--icc=false 来默认禁止容器之间的
相互访问。    

2. 访问指定端口

在通过 --icc=false 禁止容器间相互访问后，仍可以通过 --link=CONTAINER_NAME:ALIAS 选项来
允许访问指定容器的开发端口。    

## 20.4 映射容器端口到宿主主机的实现

默认情况下，容器可以主动访问到外部网络的连接，但是外部网络无法访问到容器。   

### 20.4.1 容器访问外部实现

设容器内部的网络地址为 172.17.0.2，本地网络地址为 10.0.2.2。容器要能访问外部网络，源地址不能
为 172.17.0.2，需要进行源地址映射（Source NAT, SNAT），修改为本地系统的 IP 地址 10.0.2.2。   

这说的不对啊，容器是可以访问外部网络的，上面自己都说了啊，完全弄不懂这里是什么意思啊。   

映射是通过 iptables 的源地址伪装操作实现的。查看主机 nat 表上 POSTROUTING 链的规则。该链
负责网包要离开主机前，改写其源地址：   

```
$ iptables -t nat -nvL POSTROUTING
Chain  POSTROUTING (policy ACCEPT 12 packets, 738 bytes)
pkts  bytes  target  prot opt in  out        source         destionation
0      0   MASQUERADE all  --  *  !docker0   172.17.0.0/16  0.0.0.0/
...
```    

其中，上述规则将所有源地址在 172.17.0.0/16 网段，且不是从 dockerO 接口发出的流量（即从容器中
出来的流量），动态伪装为从系统网卡发出。MASQUERADE 行动与传统 SNAT 行动相比，好处是能动态地从
网卡获取地址。    

### 20.4.2 外部访问容器实现

容器允许外部访问，可以在 docker [container] run 时候通过 -p 或 -P 参数来启用。   

不管用哪种办法，其实也是在本地的 iptable 的 nat 表中添加相应的规则，将访问外部 IP 地址的包进行
目标地址 DNAT，将目标地址修改为容器的 IP 地址。   

说实话，这里的 iptable 完全不懂。   

## 20.5 配置容器网桥

Docker 服务默认会创建一个名称为 dockerO 的 Linux 网桥（其上有一个 dockerO 内部接口），它在
内核层连通了其他的物理或虚拟网卡，这就将所有容器和本地主机都放到同一个物理网络。用户使用 Docker
创建多个自定义网络时可能会出现多个容器网桥。   

Docker默认指定了 dockerO 接口的 IP地址和子网掩码，让主机和容器之间可以通过网桥相互通信，它还
给出了 MTU（接口允许接收的最大传输单元），通常是 1500B， 或宿主主机网络路由上支持的默认值。
这些值都可以在服务启动的时候进行配置。    

每次创建一个新容器的时候，Docker 从可用的地址段中选择一个空闲的 IP 地址分配给容器的 ethO 端口，
并且使用本地主机上 dockerO 接口的 IP 作为容器的默认网关。   

# 第 21 章 libnetwork 插件化网络功能

从 1.7.0 版本开始，Docker 正式把网络与存储这两部分的功能实现都以插件化形式剥离出来，允许用户
通过指令来选择不同的后端实现。剥离出来的独立容器网络项目即为 libnetwork 项目。Docker 希望将来
能为不同类型的容器定义统一规范的网络层标准，支持多种操作系统平台。    

## 21.1 容器网络模型

libnetwork 中容器网络模型（Container Networking Model, CNM）十分简洁和抽象，可以让其上层
使用网络功能的容器最大程度地忽略底层具体实现。    

容器网络模型包括三种基本元素：   

- 沙盒（Sandbox）：代表一个容器（准确地说，是其网络命名空间）；
- 接入点（Endpoint）：代表网络上可以挂载容器的接口，会分配 IP 地址；
- 网络（Network）：可以连通多个接入点的一个子网    

@TODO:   

可见，对于使用 CNM 的容器管理系统来说，具体底下网络如何实现，不同子网彼此怎么隔离，有没有 QoS，
都不关心。只要插件能提供网络和接入点，只需把容器给接上或者拔下，剩下的都是插件驱动自己去实现，
这样就解耦了容器和网络功能，十分灵活。    

CNM 的典型生命周期如图所示：首先，驱动注册自己到网络控制器，网络控制器使用驱动类型来创建网络；
然后在创建的网络上创建接口；最后把容器连接到接口上即可。销毁过程则正好相反，先把容器从接入口上
卸载，然后删除接入口和网络即可。    

@TODO:   

目前 CNM 支持的驱动类型有四种：Null、Bridge、Overlay、Remote，简单介绍如下：   

- NULL: 不提供网络服务，容器启动后无网络连接
- Bridge: 就是 Docker 传统上默认用 Linux 网桥和 iptables 实现的单机网络
- Overlay: 使用 vxlan 隧道实现的跨主机容器网桥
- Remote: 扩展类型，预留给其他外部实现的方案

## 21.2 Docker 网络命令

在 libnetwork 支待下，Docker 网络相关操作都作为 network 的子命令出现。   

围绕着 CNM 生命周期的管理，主要包括以下命令：   

- create: 创建一个网络；
- connect: 将容器接入到网络；
- disconnect: 把容器从网络上断开
- inspect: 查看网络的详细信息
- ls: 列出所有的网络
- prune: 清理无用的网络资源
- rm: 删除一个网络    

### 21.2.1 创建网络

create 命令用于创建一个新的容器网络。Docker 内置了 bridge（默认使用）和 overlay 两种驱动，
分别支持单主机和多主机场景。Docker 服务在启动后，会默认创建一个 bridge 类型的网桥。不同网络
之间默认相互隔离。    

支持的参数包括：   

- `-attachable[=false]`: 支持手动容器挂载
- `-aux-address=map[]`: 辅助的 IP 地址
- `-config-from=""`: 从某个网络复制配置数据
- `-config-only[=false]`: 启用仅可配置模式
- `-d, -driver="bridge"`: 网络驱动类型，如 bridge 或 overlay
- `-gateway=[]`: 网关地址
- `-ingress[=false]`: 创建一个Swarm可路由的网状网络用于负载均衡，可将对某个服务的请求自动
转发给一个合适的副本；
- `-internal[=false]`: 内部模式，禁止外部对所创建网络的访间
- `-ip-range=[]`: 指定分配IP地址范围
- `-ipam-driver="default"`: IP 地址管理的插件类型
- `-ipam-opt-map[]`: IP 地址管理插件的选项
- `-ipv6`: 支持 IPv6 地址
- `-label value`: 为网络添加元标签信息
- `-o, -opt=map[]`: 网络驱动所支持的选项
- `-scope=""` 指定网络范围
- `-subnet=[]`: 网络地址段，CIDR 格式

### 21.2.2 接入网络

connect命令将一个容器连接到一个已存在的网络上。连接到网络上的容器可以跟同一网络中其他容器互通，
同一个容器可以同时接入多个网络。也可以在执行 `docker run` 命令时候通过 --net 参数指定容器
启动后自动接入的网络。    

支持参数包括：   

- `-alias=[]`: 为容器添加一个别名，此别名仅在所添加网络上可见
- `-ip=""`: 指定 IP 地址，需要注意不能跟已接人的容器地址冲突
- `-ip6=""`: 指定 IPv6 地址
- `-link value`: 添加链接到另外一个容器

## 21.3 构建跨主机容器网络

### 21.3.1 配置网络信息管理数据库

在 libnetwork 的网络方案中，要实现跨主机容器网络，也需要类似的一个网络信息管理机制，只不过这个
机制简单得多，只是一个键值数据库而己，如 Consul、Etcd、ZooKeeper 等工具都可以满足需求。   

以 Consul 为例，启动一个 progrium/consul 容器，并映射服务到本地的 8500 端口，代码如下   

```
$ docker run -d \
    -p 8500:8500 \
    -h consul progrium/consul -server -boostrap
```    

所在主机作为数据库节点。    

### 21.3.2 配置 Docker 主机

启动两台 Docker 主机 nl 和 n2，配置主机的 Docker 服务启动选项如下：   

```
DOCKER_OPTS="$DOCKER_OPTS --cluster-stroe=consul://<CONSUL_NODE>:8500
  --cluster-advertise=eth0:2376"
```    

然后重启 Docker 服务。   

### 21.3.3 创建网络

在 n1 或 n2 任意节点上创建网络 multi，例如在 nl 上执行如下命令即可完成对跨主机网络的创建：   

```
docker network create -d overlay multi
```   

然后在 n1 和 n2 上分别启动容器，使用 --net 添加到 multi 网络中即可。   
