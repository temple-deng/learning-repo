# 第 8 章 计算机网络中的安全

<!-- TOC -->

- [第 8 章 计算机网络中的安全](#第-8-章-计算机网络中的安全)
  - [8.1 什么是网络安全](#81-什么是网络安全)
  - [8.2 密码学的原则](#82-密码学的原则)
  - [8.3 报文完整性和数字签名](#83-报文完整性和数字签名)
    - [8.3.1 数字签名](#831-数字签名)
    - [8.3.2 密码散列函数](#832-密码散列函数)
    - [8.3.2 报文鉴别码](#832-报文鉴别码)
  - [8.6 SSL](#86-ssl)
    - [8.6.1 宏观描述](#861-宏观描述)
    - [8.6.2 更完整的描述](#862-更完整的描述)
  - [8.7 网络层安全性：IPsec 和虚拟专用网](#87-网络层安全性ipsec-和虚拟专用网)
    - [8.7.2 AH 协议和 ESP 协议](#872-ah-协议和-esp-协议)
    - [8.7.3 安全关联](#873-安全关联)
    - [8.7.4 IPsec数据报](#874-ipsec数据报)
    - [8.7.5 IKE：IPsec 中的密钥管理](#875-ikeipsec-中的密钥管理)

<!-- /TOC -->

## 8.1 什么是网络安全

安全通信具有下列所需要的特性。     

+ 机密性。仅有发送方和希望的接收方能够理解传输报文的内容。因为窃听者可以截获报文，这必须要求报文在一定
程度上进行 **加密**。
+ 报文完整性。通信的内容在传输过程中未被改变——或者恶意篡改或者意外改动。
+ 端点鉴别。发送方和接收方都应该能证实通信过程所涉及的另一方，以确信通信的另一方确实具有它们所声称的身份。
+ 运行安全性。防火墙和入侵检测系统等运行设备正被用于反制对机构网络的工具。防火墙位于机构网络和公共网络之间，
控制接入和来自网络的分组。入侵检测系统执行“深度分组检查”任务，向网络管理员发出有关可疑活动的警告。      

## 8.2 密码学的原则

在 **对称密钥系统** 中，Alice 和 Bob 的密钥是相同的并且是秘密的。在 **公开密钥系统** 中，
使用一对密钥：一个密钥为 Bob 和 Alice 两人所知（实际上为全世界所知），另一个密钥只要 Bob
或 Alice 知道。   

1. **块密码**    

对称加密技术有两种宽泛的类型：**流密码** 和 **块密码**。在本节中，我们关注块密码。该密码
用于多种因特网协议的加密中，包括 PGP, SSL 和 IPSec。   

在块密码中，要加密的报文被处理为 k 比特的块。例如，如果 k =64，则报文被划分为 64 比特的块，
每块独立加密。为了加密一个块，该密码采用了一对一映射，将 k 比特的明文映射为 k 比特的密文。    

上述的问题是，如果 k 选的大，如果采用全表映射，则双方都要维护一个具有 2<sup>k</sup> 个
输入值的表，这个不太好实现。    

因此块密码通常使用函数模拟随机排列表。例如 k = 64，该函数首先将 64 比特块分为 8 个块，每块
8 比特。每个 8 比特块由一个 “8 比特到 8 比特” 表处理。接下来，这 8 个输入块被重新装配成
一个 64 比特的块。该输入被回馈到 64 比特的输入，开始第二次循环，经过 n 次这样的循环，该函数
提供一个 64 比特的密文块。这种循环的目的是使得每个输入比特影响最后输出比特的大部分。这种
块密码算法的密钥将是 8 张排列表。    

目前有一些流行的块密码，包括 DES, 3DES 和 AES。这些标准中每种都使用了函数代替表。这些算法
中每种也使用了比特串作为密钥。    

DES 使用的密钥是 64 位的，但其实实际密钥长度为 56 位，剩下 8 位是奇偶校验位。   

3DES，即把一个 64 位明文用一个密钥加密，再用另一个密钥解密，然后再用第一个密钥加密。那就是
两把密钥。   

2. **密码块链接**     

注意到在块密码中，两个或更多个明文块可能是相同的。例如，两个或更多明文块中的明文可能是
“HTTP/1.1”。对于这些相同的块，块密码当然将产生相同的密文。当攻击者看到相同的密文块时，它能
潜在地猜出其明文，并且通过识别相同的密文块和利用支撑协议结构的知识，甚至能够解密整个报文。     

为了解决这个问题，我们能够在密文中混合某些随机性，使得相同的明文块产生不同的密文块。例如，
令 m(i) 表示第 i 个明文块，c(i) 表示第 i 个密文块，⊕ 表示异或，具有密钥 S 的块密码加密
算法表示为 Ks。     

其基本思想如下：发送方为第 i 块生成一个随机的 k 比特数 r(i)，并且计算 c(i) = Ks(m(i) ⊕ r(i))。
因为接收方接收到 c(i) 和 r(i)。它能够通过计算 m(i) = Ks(c(i)⊕r(i)) 而恢复每个明文块。
注意到以下事实：尽管 r(i) 是以明文发送的，可以被第三方嗅探到，但她无法获得明文 m(i)，
因为她不知道密钥 Ks。    

引入随机性产生了一个问题，传输的比特是以前的两倍。为了有效利用该技术，块密码使用了一种称为
**密码块链接**CBC 的技术。其基本思想是仅随第一个报文发送一个随机值，然后让发送方和接收方
使用计算的编码块代替后继的随机数。具体而言，CBC 运行过程如下：    

1. 在加密报文之前，生成随机串，表示为 c(0)，发送方将其以明文方式发送给对方。
2. 发送方计算 m(1)⊕c(0)。然后通过块密码算法运行得到的结果以得到对应的密文块。发送 c(1)。
3. 对于第 i 个块，发送方根据 c(i) = Ks(m(i)⊕c(i-1)) 生成第 i 个密文块。     

公开密钥系统的话就是 RSA。    


## 8.3 报文完整性和数字签名

密码术为两个通信实体提供了机密性，报文完整性将在本节介绍。   

我们再次使用 Alice 和 Bob 来定义报文完整性问题。假定 Bob 接收到一个报文，并且他认为这个
报文是 Alice 发送的，为了鉴别这个报文，Bob 需要证实：   

1. 该报文确实源自 Alice
2. 报文在传输途中没有被篡改     

### 8.3.1 数字签名

数字签名必须能实现以下三点功能：   

1. 接收者能够核实发送者对报文的签名。也就说，接收者能够确信该报文的确是发送者发送的。其他人无法
伪造对报文的签名。这叫做报文鉴别。
2. 接收者确信所收到的数据和发送者发送的完全一样而没有被篡改过。这叫做报文的完整性。
3. 发送者事后不能抵赖对报文的签名。这叫做不可否认。    

下面介绍如何使用公钥算法实现数字签名。    

为了进行签名,A用其私钥 SK<sub>A</sub> 对报文X进行D运算。D运算本来叫做解密运算。可是,还没有
加密怎么就进行解密呢?这并没有关系。因为D运算只是得到了某种不可读的密文。A把经过D运算得到的密文
传送给B。B为了核实签名,用A的公钥进行E运算,还原出明文X。请注意,任何人用A的公钥 PK<sub>A</sub>
进行E运算后都可以得出A发送的明文。可见图这种通信方式并非为了保密,而是为了进行签
名和核实签名,即确认此明文的确是A发送的。     

因为除A外没有别人持有A的私钥 SK<sub>A</sub> ,所以除A外没有别人能产生密文。这样,B就相信报文X
是A签名发送的。这就是报文鉴别的功能。同理,其他人如果篡改过报文,但由于无法得到A的私钥 SK<sub>A</sub>
来对X进行加密,那么B对篡改过的报文进行解密后,将会得出不可读的明文,就知道收到的报文被篡改过。这样
就可以保证报文的完整性。若A要抵赖曾发送报文给B,B可把X及出示给进行公证的第三者。这就是不可否认的
功能。这三项功能的关键都在于没有其他人能够持有A的私钥 SK<sub>A</sub> 。    

但是其实这里的报文鉴别和完整性鉴别只是对我们的数字签名使用的，也就说其实是为了证明证书的有效性。   

### 8.3.2 密码散列函数

理论上讲,使用上一节所讨论的数字签名就能够实现对报文的鉴别。然而这种方法有一个很大的缺点,就是对
较长的报文进行数字签名会使计算机增加非常大的负担,因为这需要进行较多的时间来进行运算。因此,我们需要
找出一种相对简单的方法对报文进行鉴别。这种方法就是使用密码散列函数。    

散列函数以 m 为输入，并计算得到一个称为散列的固定长度的字符串 H(m)。因特网校验和和 CRC 都满足这个定义。
**密码散列函数** 要求具有下列附加的性质：    

+ 找到任意两个不同的报文 x 和 y 使得 H(x)=H(y)，在计算上是不可能的。    

不严格地说，这种性质就意味着入侵者在计算上不可能用其他报文替换由散列函数保护的报文，这就是
说，如果 (m, H(m)) 是报文和散列的话，则入侵者不可能伪造另一个报文 y 的内容，使得该报文
具有与原报文相同的散列值。    

MD5 散列算法通过 4 步过程计算得到一个 128 比特的散列。第二个算法是安全散列算法 SHA-1，生成一个 160 比特
的报文摘要。     

### 8.3.2 报文鉴别码

光有散列函数的话挡不住中间人攻击。为了执行报文完整性，除了使用密码散列函数，通信双方还需要共享密钥 s。
它被称为 **鉴别密钥**。使用这个密钥，报文完整性能执行如下：   

1. A 生成报文 m，用 s 级联 m 生成 m + s，然后计算 H(m+s)，H(m+s) 被称为**报文鉴别码**（Message Authentication Code, MAC）
2. A 把 MAC 附到报文中发送。
3. B 收到报文，计算 H(m+s)     

最为流行的 MAC 标准是 HMAC。    

## 8.6 SSL

### 8.6.1 宏观描述

先从一个类 SSL 开始介绍，类 SSL 和 SSL 都具有三个阶段：握手、密钥导出和数据传输。     

1. 握手，简单来说，在 SSL 第一次握手后，C 生成一个主密钥 MS，然后用 S 的公钥加密发给 S。    
2. 密钥导出，原则上来说 MS 可以用作后面加密和数据完整性检查使用的密钥的，但是对于 S 和 C 而言，
使用不同的密码密钥，并且对于加密和完整性检查也使用不同的密钥，通常认为更安全，因此会使用 MS 生成 4 个密钥：
  + E<sub>C</sub>，用于从 C 发送到 S 的数据的会话加密密钥
  + M<sub>C</sub>，用于 C 发送到 S 的数据的会话的 MAC 密钥
  + E<sub>S</sub>，用于从 S 发送到 C 的会话加密密钥
  + M<sub>S</sub>，用于从 S 发送端 C 的数据的会话 MAC 密钥
3. 数据传输      

SSL 将数据流分割成记录，对每个记录附加一个 MAC 用于完整性检查，然后加密该 “记录 + MAC”。    

虽然这种方法几经周折，但它为整个报文流提供数据完整性时仍未达到无懈可击。特别是，假设 Trudy 是一名
“中间人”，并且有在 Server 和 Client 之间发送的 TCP 报文段流中插入、删除和代替报文段的能力。例如，
Trudy 能够捕获 Client 发送的两个报文段，颠倒这两个报文段的次序，调整 TCP 报文段的序号，然后
将这两个次序颠倒的报文段发送到 Server。这样的话，Server 收到的报文段的就是错误的。    

解决方案的话就是使用序号。SSL 采用如下的方式。Client 维护一个序号计数器，计数器从 0 开始，Client 每
发送的一个 SSL 记录它都增加1。Client 并不实际在记录中包括一个序号，但当他计算 MAC 时，他把该序号
包括在 MAC 的计算中。所以该 MAC 现在是数据加 MAC 密钥 M<sub>C</sub> 加当前序号的散列。     

SSL 记录的格式如下，类型字段指出了该字段是握手报文还是包含应用数据的报文，它也用于关闭 SSL 连接。    

![ssl](https://raw.githubusercontent.com/temple-deng/markdown-images/master/network/ssl.png)       


### 8.6.2 更完整的描述

1. **SSL 握手**     

真正的 SSL 握手的步骤如下：    

1. 客户发送它支持的密码算法的列表，连同一个客户的不重数返回给客户。
2. 从该列表中，服务器选择一种对称算法（例如 AES）、一种公钥算法（例如具有特定密钥长度的 RSA）和一种
MAC 算法。它把它的选择以及证书和一个服务器不重数返回给客户。
3. 客户验证该证书，提取服务器的公钥，生成一个 **前主密钥**（Pre-Master Secret, PMS），用服务器的公钥
加密该 PMS，并用加密的 PMS 发送给服务器。
4. 使用相同的密钥导出函数（就像 SSL 标准定义的那样），客户和服务器独立地从 PMS 和不重数中计算出 
**主密钥**（Master Secret, MS）。然后该 MS 被切片以生成两个密码和两个 MAC 密钥。此外，当选择的对称密码应用于 CBC，则两个
初始化向量（Initialization Vector, IV）也从该 MS 获得，这两个 IV 分别用于该连接的两端。
自此以后，客户和服务器之间发送的所有报文均被加密和鉴别。
5. 客户发送所有握手报文的一个 MAC。（话说这个是什么时候发的，如果随 PMS 一起发送，那是无法加密的，但是如果
不一起发送，那应该在一个服务器响应后才发送把）
6. 服务器发送所有握手报文的一个 MAC。     

2. **连接关闭**      

SSL 在类型字段会指出该记录是否用于终止该会话。     

## 8.7 网络层安全性：IPsec 和虚拟专用网      

IP 安全协议更常被称为 IPsec。IPsec 为任意两个网络层实体之间的 IP 数据报提供了安全。许多机构使用
IPsec 创建了运行在安全因特网之上的**虚拟专用网**（Virtual private network, VPN）。      

### 8.7.2 AH 协议和 ESP 协议

在 IPsec 协议族中，有两个主要协议：**鉴别首部**（Authentication Header, AH）协议和**封装安全性载荷**（ESP）
协议。当某源 IPsec 实体向一个目的实体发送安全数据报时，它可以使用AH协议和 ESP 协议来做到。AH 协议
提供源鉴别和数据完整性服务，但不提供机密性服务。ESP 协议提供了源鉴别、数据完整性和机密性服务。     

### 8.7.3 安全关联

在从源实体向目的实体发送 IPsec 数据报之前，源和目的实体创建了一个网络层的逻辑连接。这个逻辑连接称为**安全管理**（Security Association, AS）。一个SA 是一个单工逻辑连接；也就是说，它是从源到目的地单向的。如果两个
实体要互相发送安全数据报，则需创建两个 SA，每个方向一个。      

通常来说实现了 IPsec 的路由器和主机都会维护关于 SA 的状态信息，包括：    

+ SA 的 32比特的标识符，称为**安全参数索引**（Security Parameter Index, SPI）。
+ SA 的初始接口和 SA 的目的接口。
+ 将使用的加密类型
+ 加密密钥
+ 完整性检测的类型
+ 鉴别密钥       

一个 IPsec 实体在它的**安全关联数据库**（Security Association Database, SAD）中存储其所有 SA
的状态信息，SAD 是实体操作系统内核的一个数据结构。     

### 8.7.4 IPsec数据报

IPsec 有两种不同的分组形式，一种用于所谓的**隧道模式**，一种是**运输模式**。本节主要关注隧道模式。    

IPsec 数据报格式如下：    

@TODO 此处该有图。     

下面是一个源主机的第一跳路由器收到源主机的普通 IPv4 数据报的处理流程（话说这里没讲建立连接的阶段）：    

+ 在初始 IPv4 数据报后面附加一个“ESP 尾部”字段。
+ 使用算法和 SA 规定的密钥加密该结果。
+ 在加密量前面附加一个“ESP 首部”字段，得到被称为“enchilada"的包
+ 使用算法和 SA 规定的密钥生成一个覆盖 enchilada 的鉴别 MAC。
+ 将 MAC 附到 enchilada 后形成载荷。
+ 最后，生成一个具有所有经典 IPv4 首部字段的全新 IP 首部，将首部附加到载荷之前。       

首先需要注意的是源 IP 首部中的地址是直接通信的两个主机的 IP 地址，而新的 IP 首部中的地址应该是两个
主机通信的第一跳路由器的 IP 地址（即接入因特网设备的地址）。其次新首部中的协议号为 50，指示这是
一个使用 ESP 协议的 IPsec 数据报。     

### 8.7.5 IKE：IPsec 中的密钥管理

大型的、地理上分散的部署要求一个自动的机制来生成 SA。IPsec 使用**因特网密钥交换**（Internet Key Exchange, IKE）协议来从事这项工作。     

IKE 和 SSL 中的握手类似。每个 IPsec 实体具有一个证书，该证书包括了该实体的公开密钥。如同使用 SSL 一样，
IKE 协议让两个实体交换证书，协商鉴别和加密算法，并安全地交换用于在 IPsec SA 中生成会话密钥的密钥材料。与
SSL 不同的是，IKE 应用两个阶段来执行这些任务。      

具体过程没看懂。。          