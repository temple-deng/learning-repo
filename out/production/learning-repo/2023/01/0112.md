# 0112

- [0112](#0112)
  - [immer](#immer)
    - [æŸ¯é‡ŒåŒ–](#æŸ¯é‡ŒåŒ–)
    - [hooks](#hooks)
    - [ç±»](#ç±»)
    - [ä» draft ä¸­å¯¼å‡ºå½“å‰ state](#ä»-draft-ä¸­å¯¼å‡ºå½“å‰-state)


## immer

å…ˆçœ‹ä¸‹å®ƒæ˜¯ä¸ºäº†è§£å†³ä»€ä¹ˆé—®é¢˜å­˜åœ¨çš„ã€‚æœ¬è´¨ä¸Šï¼Œæ˜¯ä¸ºäº†è§£å†³ç»„ä»¶æ›´æ–° state çš„æ—¶å€™ï¼Œå¦‚æœé‡åˆ°äº†å±‚æ¬¡ç»“æ„æ¯”è¾ƒæ·±çš„
å¯¹è±¡æˆ–è€…æ•°ç»„ï¼Œæˆ‘ä»¬è¦å˜æ›´å…¶ä¸­çš„æŸä¸ªå­—æ®µï¼Œé‚£æ›´æ–°çš„æ—¶å€™ï¼Œå¯èƒ½è¦åå¤çš„ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦ï¼Œç”Ÿæˆæ–°çš„å¯¹è±¡ç»“æ„ã€‚è€Œä¸æ˜¯ç›´æ¥åƒ vue é‚£æ ·ä¿®æ”¹å³å¯ã€‚    

```js
state = {
  a: {
    b: {
      c: 1
    }
  }
};

// ä¿®æ”¹ c ä» 1->2
state = {
  a: {
    b: {
      c: 2
    }
  }
}

state = [{}, {b: 1}, {}, {}];

// ä¿®æ”¹ state[1] = { b: 2 };
state = [
  ...state.slice(0, 1),
  {b: 2},
  ...state.slice(2)
];
```      

èƒ½çœ‹å‡ºæ¥ï¼Œä¸ºäº†ä¿®æ”¹ä¸€ä¸ªå­—æ®µï¼Œä¸ºäº†é¿å…ç›´æ¥å¯¹æº state å¯¹è±¡çš„ç›´æ¥ä¿®æ”¹ï¼Œéƒ½å¾—åˆ›å»ºä¸€ä¸ªæ–°çš„çš„å¯¹è±¡å»å¤„ç†ï¼Œæ•´ä¸ªä»£ç é‡å°±å¢åŠ äº†ï¼Œå½“ç„¶äº†æˆ‘ä»¬ä¹Ÿå¯ä»¥é€‰æ‹©ä½¿ç”¨ä¾‹å¦‚ cloneDeep çš„æ–¹å¼åˆ›å»ºä¸€ä»½å‰¯æœ¬æ¥å¤„ç†ï¼Œä½†æ˜¯è¿™æ ·çš„è¯ï¼Œæ„Ÿè§‰æ€§èƒ½ä¸Šåˆæœ‰ç‚¹å·®ï¼Œè€Œä¸”æœ‰ç‚¹æµªè´¹å†…å­˜ã€‚    

æ‰€ä»¥å°±æœ‰äº†è¿™ç§ç±»ä¼¼ immutable åº“çš„å‡ºç°çš„æ–¹æ¡ˆï¼Œä½†æ˜¯è€å®è¯´ï¼Œå®ƒä¼šä¸ä¼šåƒ cloneDeep çš„æ–¹æ¡ˆä¸€æ ·ï¼Œæˆ‘è¿˜ä¸æ˜¯å¾ˆæ¸…æ¥šã€‚     

å½“ç„¶äº†ï¼Œä½¿ç”¨ immutable çš„å¦ä¸€ä¸ªå¥½å¤„å°±æ˜¯ï¼Œstate çš„å˜æ›´å¯ä»¥æ›´æ–¹ä¾¿çš„å›æº¯ï¼Œä¸è¿‡ç­‰ç­‰ï¼Œè¦å›æº¯çš„è¯ï¼Œè‡³å°‘è¦ä¿å­˜æ¯æ¬¡ä¿®æ”¹çš„å€¼ï¼Œæ„Ÿè§‰å¯¹å­˜å‚¨ç©ºé—´ä¹Ÿå¯èƒ½ä¼šæµªè´¹å•Šã€‚   

ä½†æ˜¯æŠŠï¼Œè€å®è¯´ï¼Œä½¿ç”¨ immutable data çš„ä¼˜ç‚¹ç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Œæ„Ÿè§‰æˆ‘è¿˜ä¸æ˜¯å¾ˆæ¸…æ¥šã€‚æœäº†ä¸€äº›å†…å®¹ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ä¸€ä¸ªç­”æ¡ˆèƒ½å¤Ÿè¯´æœæˆ‘ä½¿ç”¨ immutable data ç¡®å®ä¼šåœ¨æŸæ–¹é¢å¸¦æ¥å¾ˆå¤§çš„å¥½å¤„ã€‚æ›´å¤šçš„éƒ½æ˜¯è¾¹è¾¹è§’è§’çš„ä¼˜ç‚¹ã€‚   

å…ˆçœ‹ä¸‹æ–‡æ¡£çš„ç”¨æ³•ã€‚   

```js

import produce from "immer"
const baseState = [
    {
        title: "Learn TypeScript",
        done: true
    },
    {
        title: "Try Immer",
        done: false
    }
]

const nextState = produce(baseState, draft => {
    draft[1].done = true
    draft.push({title: "Tweet about it"})
})
```     

æ–‡æ¡£ä¸Šæ˜¯è¿™ä¹ˆä»‹ç»åŸç†çš„ï¼šæˆ‘ä»¬åšå˜æ›´çš„é‚£ä¸ª draft å¯¹è±¡ï¼Œæ˜¯å¯¹ currentState ä¸€ä¸ªä»£ç†ï¼Œä¸€æ—¦æˆ‘ä»¬æ‰€æœ‰çš„ä¿®æ”¹å®Œæˆäº†ï¼Œimmer ä¼šåŸºäºæˆ‘ä»¬å¯¹ draft çš„ä¿®æ”¹ç”Ÿæˆ nextStateã€‚    

æ³¨æ„ç†è®ºä¸Šé‚£äº›æ²¡æœ‰å˜åŠ¨çš„å­—æ®µï¼Œå…ƒç´ ï¼ŒnextState å’Œ currentState ç”¨çš„æ˜¯åŒä¸€ä¸ªå‰¯æœ¬ã€‚  

### æŸ¯é‡ŒåŒ–

å°†å‡½æ•°ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ç»™ produce ä¼šåˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°å°šæœªå°† produce åº”ç”¨äºç‰¹å®š stateï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°å°†åº”ç”¨äºå°†æ¥ä¼ é€’ç»™å®ƒçš„ä»»ä½• stateã€‚è¿™é€šå¸¸ç§°ä¸ºæŸ¯é‡ŒåŒ–ã€‚     

```js
import produce from "immer"

// curried producer:
const toggleTodo = produce((draft, id) => {
    const todo = draft.find(todo => todo.id === id)
    todo.done = !todo.done
})

const baseState = [
    /* as is */
]

const nextState = toggleTodo(baseState, "Immer")
```    

### hooks    

```js
import React, { useCallback } from "react";
import { useImmer } from "use-immer";

const TodoList = () => {
  const [todos, setTodos] = useImmer([
    {
      id: "React",
      title: "Learn React",
      done: true
    },
    {
      id: "Immer",
      title: "Try Immer",
      done: false
    }
  ]);

  const handleToggle = useCallback((id) => {
    setTodos((draft) => {
      const todo = draft.find((todo) => todo.id === id);
      todo.done = !todo.done;
    });
  }, []);

  const handleAdd = useCallback(() => {
    setTodos((draft) => {
      draft.push({
        id: "todo_" + Math.random(),
        title: "A new todo",
        done: false
      });
    });
  }, []);
```   

### ç±»    

æ–‡æ¡£çš„æ„æ€æ˜¯ immer åªèƒ½å°†æ™®é€šå¯¹è±¡ï¼Œæ•°ç»„ï¼Œmapï¼Œset draftedï¼Œå…¶ä»–çš„å¯¹è±¡éœ€è¦ä½¿ç”¨ symbol è¿›è¡Œæ ‡è®°ã€‚   

```js
class Clock {
  constructor(hour, minute) {
    this.hour = hour;
    this.minute = minute;
  }

  get time() {
    return `${this.hour}:${this.minute}`;
  }

  tick() {
    return produce(this, draft => {
      draft.minute++;
    });
  }
}

const c1 = new Clock(12, 10);
const c2 = c1.tick();  // è¿™é‡Œä¼šæŠ¥é”™
console.log(c1.time);
console.log("ğŸš€ ~ file: app.js:37 ~ c2", c2.time);
console.log(c2 instanceof Clock);
```   

ä¸å¤ªç†è§£ä¸ºä»€ä¹ˆè¦è¿™æ ·ï¼Œæˆ‘éƒ½æœ‰ç‚¹å¥½å¥‡å®ƒæ˜¯æ€ä¹ˆåˆ¤æ–­çš„å‘¢ã€‚    

### ä» draft ä¸­å¯¼å‡ºå½“å‰ state

current å‡½æ•°æ”¯æŒä» draft å½“å‰çš„çŠ¶æ€åˆ›å»ºä¸€ä»½å‰¯æœ¬ã€‚æœ‰ç‚¹ç±»ä¼¼ draft åœ¨æŸä¸€åˆ»çš„å¿«ç…§ã€‚   

```js
const base = {
    x: 0
}

const next = produce(base, draft => {
    draft.x++
    const orig = original(draft)
    const copy = current(draft)
    console.log(orig.x)
    console.log(copy.x)

    setTimeout(() => {
        // this will execute after the produce has finished!
        console.log(orig.x)
        console.log(copy.x)
    }, 100)

    draft.x++
    console.log(draft.x)
})
console.log(next.x)

// This will print
// 0 (orig.x)
// 1 (copy.x)
// 2 (draft.x)
// 2 (next.x)
// 0 (after timeout, orig.x)
// 1 (after timeout, copy.x)
```    

è¿™ä¸ªä¾‹å­é‡Œé¢ orig å’Œ base å¥½åƒæ˜¯ä¸€ä¸ªå€¼ã€‚   

