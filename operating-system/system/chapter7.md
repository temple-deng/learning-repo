# 第 7 章 中断

## 7.1 什么是中断

由于 CPU 获知了计算机中发生了某些事，CPU 暂停正在执行的程序，转而去执行处理器该事件的程序，
当这段程序执行完毕后，CPU 继续执行刚才的程序。整个过程称为中断处理，也称为中断。    

## 7.3 中断分类

把中断按事件来源分类，来自 CPU 外部的中断就称为 **外部中断**，来自 CPU 内部的中断的称为
**内部中断**。其实还可以再细分，外部中断按是否导致宕机来划分，可分为 **可屏蔽中断** 和
**不可屏蔽中断**，而内部中断按中断是否正常来划分，可分为 **软中断** 和 **异常**。    

### 7.3.1 外部中断

外部中断源必须是某个硬件，所以外部中断也称为 **硬件中断**。比如说网卡收到了来自网络的数据
包，这时候网卡会主动通知 CPU。    

CPU 为外部硬件准备了两条信号线，中断是通过这两条信号线通知到 CPU 的。这两根信号线就是
INTR(INTeRupt) 和 NMI(Non Maskable Interrupt)。    

只要从 INTR 引脚收到的中断都是不影响系统运行的，可以随时处理，甚至 CPU 可以不处理，因为
它不影响 CPU 运行。而只要从 NMI 引脚收到的中断，基本上都是硬伤，CPU 都没有运行下去的必要。    

可屏蔽中断是通过 INTR 引脚进入 CPU 的，外部设备如硬盘、网卡等发出的中断都是可屏蔽中断。
系统甚至可以将 FLAGS 寄存器的 IF 位将这些可屏蔽中断屏蔽掉。另外，这些设备都是接在某个
中断代理设备的，通过该中断代理可以单独屏蔽某个设备的中断。    

对于这类可屏蔽中断，CPU 可以选择不用理会，甚至，即使在理会后，也可以像 Linux 那样，把中断
分为上半部和下半部分开处理。   

操作系统是中断驱动的，中断发生后会执行相应的中断处理程序，我们希望 CPU 中断响应的时间
越短越好，这样便能响应更多设备的中断。但是中断处理程序还是需要完整的执行的。于是，把中断
处理程序分为上半部和下半部两部分，把中断处理程序中需要立即执行的部分划分到上半部，这部分
是要限时执行的，所以通常情况下只完成中断应答或硬件复位等重要紧迫的工作。而中断处理程序
中那些不紧急的部分则被推迟到下半部中去完成。由于中断处理程序的上半部是刻不容缓要执行的，
所以上半部是在关中断不被打扰的情况下执行的。当上半部执行完成后就把中断打开了，下半部也属于
中断处理程序，所以中断处理程序下半部则是在开中断的情况下执行的，如果有新的中断发生，原来
这个旧中断的下半部就会被换下 CPU，先执行新的中断处理程序的上半部，等待线程调度机制为旧
中断处理程序择机运行。    

不可屏蔽中断是通过 NMI 引脚进入 CPU 的，它表示系统中发生了致命的错误。   

中断发起时，相应的中断向量号通过 NMI 或 INTR 引脚被传入 CPU，中断向量号是中断向量表或
中断描述符表里中断项的下标，CPU 根据此中断向量号在中断向量表或中断描述符表中检索对应的
中断处理程序并去执行。    

可屏蔽中断并不会导致致命问题，它的数量是有限的，所以每一种中断源都可以获得一个中断向量号。
而不可屏蔽中断引起的致命错误原因有很多，多数属于物理上的问题，原因对软件工程师来说意义不大，
没必要再细分原因，因此只要分配一个中断向量号即可，所以不可屏蔽中断的中断向量号为 2.    

### 7.3.2 内部中断

内部中断可分为软中断和异常。    

软中断就是软件主动发起的中断。由于它是软件中主动发起的，所以它是主观上的，并不是客观上的
某种内部错误。   

以下是可以发起中断的指令：   

+ `int 8位立即数`
+ `int3`, `int3` 是调试断点指令，其所触发的中断向量号是 3.
+ `into` 这是中断溢出指令，它所触发的中断向量号是 4.
+ `bound` 这是检查数组索引越界指令，它可以触发 5 号中断。
+ `ud2` 未定义指令，触发 6 号中断，该指令表示指令无效，CPU 无法识别    

除第一种 `int 8位立即数` 外，其他的几种又可以称为异常，因为他们既具备软中断的 “主动” 行为，
又具备异常的 “错误” 结果。    

异常是指指令运行期间 CPU 内部产生的错误引起的。按照轻重程度，可以分为三种类型：     

1. Fault，故障。这种错误是可以被修复的一种类型。当发生此类异常时 CPU 将机器状态恢复到异常
之前的状态，之后调用中断处理程序时，CPU 将返回地址依然指向导致 fault 异常的那条指令。
2. Trap，陷阱。此异常通常用于调试中，比如 int3，为了让中断处理程序返回后能够继续向下
执行，CPU 将中断处理程序的返回地址指向导致异常的下一个指令地址
3. Abort，终止。一旦出现，由于错误无法修复，程序将无法继续运行，操作系统会将此程序从进程
表中去掉。     

## 7.4 中断描述符表

中断描述符表(Interrupt Descriptor Table, IDT) 是保护模式下用于存储中断处理程序入口的表。   

### 7.4.1 中断处理过程及保护

完整的中断过程分为 CPU 外和 CPU 内两部分：   

+ CPU 外：外部设备的中断由中断代理芯片接收，处理后将该中断的中断向量号发送到 CPU
+ CPU 内：CPU 执行该中断向量号对应的中断处理程序    

本节先介绍处理器内的过程，这是软件能控制的部分：   

1. 处理器根据中断向量号定位中断门描述符    
2. 处理器进行特权级检查    

中断向量号只是个整数，其中并没有 RPL，所以在对由中断引起的特权级转移做特权级检查中，并
不涉及 RPL。中断门的特权检查同调用门类似，对于软件主动发起的软中断，当前特权级 CPL 必须
在门描述符 DPL 和门中，目标代码段 DPL 之间。     

3. 执行中断处理程序    

# 第 9 章 线程

## 9.1 实现内核线程

### 9.1.5 进程的身份证-PCB

操作系统位每个进程提供了一个 PCB, Process Control Block，它就是进程的身份证，用它来记录
此进程相关的信息，比如进程状态、PID、优先级等。   

每个进程都有自己的 PCB，所有 PCB 放到一张表格中维护，这就是进程表，调度器可以根据这张表
选择上处理器运行的进程。   

### 9.1.6 实现线程的两种方式——内核或用户进程

在用户进程实现线程有以下优点：   

+ 线程的调度算法是由用户程序自己实现的，可以根据实现应用情况位某些线程加权调度
+ 将线程的寄存器映像装载到 CPU 时，可以在用户空间完成，即不用陷入到内核态，这样就免去了
进入内核时的入栈及出栈操作

缺点是：    

+ 进程中的某个线程若出现了阻塞，操作系统不知道进程中存在线程，它认为是进程出现了阻塞，
因此会将整个进程挂起。    
+ 如果某个线程不主动让出处理器，此进程中的其他线程都没有机会运行。
+ 进程内线程调度器维护线程表、运行调度算法的时间片消耗，抵消了陷入内核调度带来的提速   

内核空间实现线程的优点：   

+ 阻塞调用不再受影响

# 第 11 章 用户进程



