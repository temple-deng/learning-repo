# 第 7 章 虚拟化和云

<!-- TOC -->

- [第 7 章 虚拟化和云](#第-7-章-虚拟化和云)
  - [7.2 虚拟化的必要条件](#72-虚拟化的必要条件)
  - [7.3 第一类和第二类虚拟机管理程序](#73-第一类和第二类虚拟机管理程序)
  - [7.4 高效虚拟化技术](#74-高效虚拟化技术)

<!-- /TOC -->

虚拟化的主要思想是 **虚拟机监控程序**（Virtual Machine Monitor, VMM）在同一物理硬件上创建出
有多台虚拟机器的假象。VMM 又称为**虚拟机管理程序**（hypervisor）。VMM 分为第一类虚拟机管理程序
和第二类虚拟机管理程序。前者运行在裸机上，后者依赖于底层操作系统提供的服务和抽象。无论是哪一类，虚拟化
技术都运行单一计算机上运行多个虚拟机，各虚拟机能运行不同的操作系统。    

## 7.2 虚拟化的必要条件

虚拟机管理程序需要在以下三个维度上有良好的表现：   

1. **安全性**：虚拟机管理程序应完全掌控虚拟资源。
2. **保真性**：程序在虚拟机上执行的行为应与裸机上相同。
3. **高效性**：虚拟机中运行的大部分代码应该不受虚拟机管理程序的干涉。    

在**解释器**中逐条考虑指令并准确执行其行为是一种安全执行指令的方式。有些指令可以直接运行，例如解释器可以
按原样执行INC（增量）指令，其他不能安全直接执行的指令需要由解释器进行模拟。不过解释器的性能堪忧，为了满足
性能要求，我们将看到虚拟机管理程序试图直接执行大多数代码。    

然后是保真性。虚拟化在 x86 上一直是个问题。因为在每个包含内核态和用户态的 CPU 中都有一个特殊的指令集合，
其中的指令在内核态和用户态执行的行为不同。这些指令包括进行 I/O 操作和修改 MMU设置的指令。Popek 好
Goldberg 称之为**敏感指令**。还有一个指令集合，其中的指令在用户态执行时会导致陷入，Popek 和 Goldberg
称之为**特权指令**。它们指出机器可虚拟化的一个必要条件是敏感指令是特权指令的子集。即用户态想要做不应该
在用户态做的事情，硬件必须陷入。386没有这一特性，因此不能虚拟化。（之所以必须是子集应该是因为，加入用户
操作系统执行一个敏感指令，它本期望应该是内核态的指令结果，但其实用户操作系统是运行在用户态，因此最终结果
可能会不一致）    

不过从05年起，Inter 和 AMD 在 CPU 中引入了虚拟化支持，在 Inter 中这项技术叫做 VT（virtualization Technology），
在 AMD 中叫做 SVM（Secure Virtual Machine）。VT 技术的基本思想是创建可以运行虚拟机的容器，客户操作系统
在容器中启动并持续运行，直到触发异常并陷入虚拟机管理程序，直到触发异常并陷入虚拟机管理程序，有了这些扩展，
在x86 平台实现经典的**陷入并模拟**虚拟机就称为可能。    

## 7.3 第一类和第二类虚拟机管理程序

从技术上讲，第一类虚拟机管理程序就像一个操作系统，因为它是唯一一个运行在最高特权级的程序，它的工作是
支持真实硬件的多个虚拟机拷贝，类似与普通操作系统支持的进程。    

第二类虚拟机管理程序是一个依赖与 Windows、Linux 等操作系统分配和调度资源的程序，很像一个普通的进程。    

运行在两类虚拟机管理程序上的操作系统都称作**客户操作系统**。对于第二类虚拟机管理程序，运行在底层硬件上的
操作系统称为**宿主操作系统**。     

## 7.4 高效虚拟化技术


以第一类虚拟机管理程序为例，当（认为自己处于内核态）客户操作系统执行了一条只有 CPU 真正处于内核态才允许执行的指令时，会发生什么呢？通常在不支持 VT 的 CPU 上，这条指令执行失败并导致操作系统崩溃。在支持 VT 的 CPU 上，客户操作系统
执行敏感指令时，会陷入虚拟机管理程序。虚拟机管理程序可以检查这条指令是由虚拟机中的客户操作系统执行的
还是用户程序执行的。如果是前者，虚拟机管理程序将安排这条指令功能的正确执行。否则，虚拟机管理程序将
模拟真实硬件面对用户态执行敏感指令时的行为。    

