# openstack

## 云计算

云计算就是从买“计算机”变成买“计算能力”，减少成本支出，并提升了效率。     

云 != 虚拟化，云化的目的是为了实现效用计算，弹性计算，动态资源调度，多租户等这样的一些特性；而虚拟化只是实现云计算的这些特性中的一个技术手段而已，而且它不是必需的。   

云在我们心中的印象非常简单，但是形态各异。Gmail、Salesforce.com或者任何你需要通过网页浏览到的东西，统称为SaaS，软件即服务。这也是大部分用户所认知到“云”的形态。另外还有两个缩写经常用来描述不同云的形态，分别是PaaS(平台即服务)和IaaS(基础架构即服务)。    

有了原始的计算资源服务，你可以运行自己的软件(PaaS)，或者能拥有你想用的硬件(IaaS)。亚马逊网络服务(AWS)和Rackspace都是IaaS的例子，Google App Engine是PaaS的典范。

## 架构

当前版本 Pike

OpenStack是一个云操作系统，通过数据中心可控制大型的计算、存储、网络等资源池。所有的管理通过前端界面管理员就可以完成，同样也可以通过web接口让最终用户部署资源。   

OpenStack 是一套框架 —— API，它有两个特点：
它是一个中间层，可以创建、管理和销毁虚拟机，但是要完成这些操作需要依赖于第三方的 Hypervisor，通过这个 Hypervisor 去完成虚拟化的工作，OpenStack 并不能自己去提供一个虚拟化的运行环境，OpenStack 有个组件叫 Cinder（用来提供块存储服务的），但是 OpenStack 自己并不能进行数据的存储和读写，它需要依赖一个实际的块存储设备的支持，这个设备可以是一个分布式的存储系统，比如说 Ceph，也可以是一个存储设备，比如说 EMC 的 SAN，也可以是存储服务器的本地硬盘，但是它必须依赖一个存储设备的支持，OpenStack 本身并不具备这个功能。OpenStack 是一个中间层。    

框架有一个很重要的特点，那就是它能提供一批 API 去支持应用的开发，这也是我们业内对框架的一个定义，OpenStack 当然也有这个特点，云计算的愿景就是让用户能够像用电一样去使用计算，OpenStack 的设计也是朝着这个愿景去做设计的，但是实际上我们平时是不能直接用电的，我们需要用的是电冰箱、电脑、电视等等这些电器。同理，对于云计算来说，提供 API 去支持开发应用这个事情就合情合理的非常的重要了，具有完备的 API 是 OpenStack 的突出优点。    

OpenStack 作为一个操作系统，管理资源是它的首要任务；    

OpenStack 管理资源主要有三个方面：计算、存储和网络。    

OpenStack 对资源进行管理，并且以服务的形式提供给上层应用或者用户去使用。这些资源的管理是通过 OpenStack 中的各个项目来实现的。    


其中计算资源管理相关的项目是 Nova（又称为 OpenStack Compute）；   

存储相关的主要有块存储服务 Cinder、对象存储服务 Swift、镜像存储服务 Glance 这三种；    

与网络相关的主要是一个和软件定义网络相关的项目叫作 Neutron；另外，Nova 中间有一个管理网络的模块叫作 Nova Network，作为一个比较稳定的遗留组件仍在 OpenStack 里面和 Neutron 并存，我们在小规模部署里面经常为了追求这种稳定，并且减少工作量会去使用 Nova Network 这样的一个组件来对网络资源进行管理。    


## 虚拟化

几个和虚拟化相关的常见概念：   

+ 虚拟机：是指利用虚拟化技术，通过软件模拟完整的计算机硬件系统功能，构造出的完整虚拟计算机系统。该虚拟机可以运行在一个完全隔离的环境中，像使用本地计算机一样安全可靠。    
+ Hypervisor：即虚拟机监视器 VMM(Virtual Machine Monitor)，是一种运行在基础物理服务器和操作系统之间的中间软件层，可运行多个操作系统和应用共享硬件。Hypervisor 是一种在虚拟环境中的“元”操作系统。它可以访问服务器上包括磁盘和内存在内的所有物理设备。Hypervisor 不但协调者这些硬件资源的访问，也同时在各个虚拟机之间施加防护。当服务器启动并执行 Hypervisor 时，它会加载所有虚拟机客户端的操作系统，同时分配给每一台虚拟机适量的内存、CPU等。
+ Xen Hypervisor：是一个开源的采用半虚拟化技术的VMM，负责在各虚拟机之间进行CPU调度和内存分配。Xen Hypervisor抽象出硬件层，并控制虚拟机的执行，但不会处理网络、存储设备、视频以及其他I/O（输入/输出）。由于Xen Hypervisor可以在单个计算机上运行多个修改过的操作系统，且最上层的用户应用无需做特殊修改，因此Xen Hypervisor无需特殊硬件支持，就能达到高性能的虚拟化。
+ 宿主操作系统：Host OS 是指被虚拟的物理机的操作系统。
+ 客户操作系统：Guest OS 是指运行在虚拟机上的操作系统。   

一种叫做 Hypervisor （虚拟机监控程序）的软件可有效分隔物理资源，并将这些资源分配给不同虚拟环境（也就是需要这些资源的任务）使用。虚拟机监控程序可能位于操作系统的顶层（例如在便携式计算机上），或者直接安装在硬件上（例如服务器），这是大多数企业使用虚拟化的方式。虚拟机监控程序接管物理资源，并对它们进行划分，以便虚拟环境能够对其进行使用。      

来自物理环境的资源根据需要进行了分区，分配给了很多虚拟环境使用。用户在虚拟环境（通常称为客户机或虚拟机）内部，能够与计算任务交互，并运行计算。虚拟机作为单个数据文件运行。与任何数字文件相同，虚拟机可从一台计算机迁移至另一台计算机，在任何一台计算机上打开，工作方式都是相同的。     

当虚拟环境正在运行时，用户或程序发出一条指令，请求来自物理环境的更多资源， 虚拟机监控程序会将请求传递到物理系统并缓存更改 — 所有这些必须在接近本机的速度下进行。      

### 虚拟化的类型

最常见的虚拟化资源包括服务器、操作系统和网络。     

服务器是用于处理大量特定任务的计算机，这样可让其他计算机（例如便携式计算机和台式机）能够执行其他各种任务。通过虚拟化服务器，可以让它们执行特定功能，这需要进行分区，以便使用各个组件来运行多种功能。     

操作系统虚拟化在内核中进行，内核则是操作系统的中央任务管理器。这是并行运行 Linux 和 Windows 环境的实用方式。     

网络功能虚拟化可以隔离网络的关键功能（例如目录服务、文件共享和 IP 配置），并将它们分到各个不同的环境中。一旦软件功能独立于物理计算机，特定功能便可以组合成为新网络，并分配给环境。虚拟化网络可以减少物理组件的数量，例如交换机、路由器、服务器、线缆和集线器，它们都是创建多个独立网络所必需的资源，这种虚拟化方式在电信行业中使用尤其广泛。    

### 虚拟机的主要特性

+ 分区
  - 可在一台物理机上运行多个操作系统
  - 可在虚拟机之间分配系统资源
+ 隔离
  - 可在硬件级别进行故障和安全隔离
  - 可利用高级资源控制功能保持性能
+ 封装
  - 可将虚拟机的完整状态保存在文件中
  - 移动和复制虚拟机就像移动和复制文件一样轻松
+ 独立与硬件
  - 可将任意虚拟机调配或迁移到任意物理服务器


## 简介

openstack 操作系统包含几个可以分别安装的关键服务。这些服务可以根据你云的需要一起工作，包括计算服务，身份验证服务，网络服务，镜像服务，块存储服务，对象存储服务，Telemetry（遥测服务？）,云编排服务以及数据库服务。    

下面的表格展示了 openstack 的服务：   


服务 | 项目名 | 描述
---------|----------|---------
 Dashboard | Horizon | 提供了一个基于 web 的自助面板用来和底层的 OpenStack 服务交互。例如启动实例，安排 IP 地址或者配置访问权限等任务都可以通过这个面板完成。
 Compute service | Nova | 管理 openstack 环境中的计算实例的生命周期。责任包括按需生成、调度及回收虚拟机。    
 Networking service | Neutron | 为启动服务例如计算服务提供网络连接即服务的功能。为用户定义网络及绑定到各个服务提供了API。网络服务的架构是可插拔的，可以支持多种流行的网络供应商和技术。其数据复制和横向扩展架构提供了高度的容错能力。
 Object Storage service | Swift | 通过 RESTful API 存储和检索任意的非结构化的数据对象。
 Block Storage service | Cinder | 为运行实例而提供的持久性块存储。它的可插拔驱动架构的功能有助于创建和管理块存储设备。
 Identity service | Keystone | 为其他OpenStack服务提供认证和授权服务，为所有的OpenStack服务提供一个端点目录。
 Image service | Glance | 存储和检索虚拟机硬盘镜像。
 Telemetry service | Ceilometer | 为OpenStack云的计费、基准、扩展性以及统计等目的提供监测和计量。
 Orchestration service | Heat | 略
 Database service | Trove | 略  


下面的图表展示了几个 openstack 服务之间的关系：   

![openstack architecture](https://docs.openstack.org/install-guide/_images/openstack_kilo_conceptual_arch.png)   

逻辑架构。所以的服务都是通过共同的身份验证服务认证的。除了那些需要管理员命令的权限服务，各个独立的服务都通过 public API 和其它服务交流。    

在内部，openstack 服务是由几个进程组成的。所有的服务都至少有一个 API 进程，这个进程会监听 API 请求，对请求进行预处理然后将其传递给服务的其它部分。除了身份验证服务，这个工作其实是由独立的进程完成的。    

为了每个服务中的进程的交流，使用了一个 AMQP message broker。服务的状态是存储到一个数据库中的。也就说，服务间的通信是通过 public API，一个服务内的进程间通信是通过这个 AMQP。当部署和配置 openstack 云的时候，可以在几种不同的message broker 和数据库解决方案，例如 RabbitMQ, MySQL, MariaDB 和 SQLite。    

用户可以通过基于 web 的 Horizon 的管理界面，或者命令行客户端访问 openstack，可以通过浏览器插件或者 curl 发送 API 请求。   

## 架构的例子

![example](https://docs.openstack.org/install-guide/_images/hwreqs.png)    

### Controller 

controller 节点会运行身份验证服务，镜像服务，计算服务的管理部分，网络服务的管理部分，各种网络代理，以及面板。    

controller 节点最低要求两个网卡。         

### Compute

计算节点运行了操作实例的计算服务的 hypervisor 部分。默认情况下，计算使用 KVM hyervisor。compute 节点同样运行了一个网络服务代理来将实例与虚拟网络连接起来，并未实例提供防火墙服务。    

可以部署多个 compute 节点。每个节点都最低要求两个网卡。    

## 网络

选择下面之一的虚拟网络选项。   

### 选项一：Provider networks

供应商网络选项以最简单的方式部署 openstack 网络服务，主要是 layer-2（桥接/交换）服务和网络的 VLAN 分段。本质上，它将虚拟网络和物理网络相结合，并依赖物理网络基础设施进行 layer-3（路由）服务。   

### 选项二：Self-service networks

self-service 网络在 layer-3 路由服务中启用了覆盖分段方法例如 VXLAN 增强了 provider 选项。本质上，它使用 NAT 将虚拟网络路由到物理网络。  

## 安装

最低要求，需要安装一下的服务，并且是按序安装：   

+ 身份验证
+ 镜像
+ 计算
+ 网络


## Nova

Nova 服务提供了监控计算实例的方式。Nova 支持创建虚拟机，金属裸机（通过视同 ironic），部分支持系统容器。Nova 提供这些服务通过运行在 Linux 服务器顶层的一系列守护进程实现。    

Nova 要求以下的几个服务来提供基础的功能：  

+ Keystone
+ Glance：这个服务提供了计算镜像仓库。所有的计算实例都是从 glance 镜像启动的。
+ Neutron：这个服务负责监控计算实例在启动时连接的虚拟或者物理网络。    

对于终端用户来说，我们通过相关的工具或者 API 来使用 nova 来创建和管理服务器。    

Nova的工具有：   

+ Horizon：openstack 官方的web ui工具
+ OpenStack Client: OpenStack 项目的官方 CLI 工具。
+ Nova Client：如果要使用一些高级的 nova 功能，可以会需要使用这个。     

nova 所有的终端用户的功能都是通过 REST API 暴露出来的，这些功能可以用来构建更复杂的逻辑。这些 API 可以直接消费，或者通过其他的 SDK。下面的资源会帮助我们在直接消费 API 时能快速开始：   

+ Compute API Guide: API 理念的指导。帮助我们理清API 后的整个布局。
+ Compute API Reference: API 的完整引用
+ Compute API Microversion History: API 随着时间的推移通过 Microversion 演变。   

### Nova 系统架构

Nova 由多个服务器进程组成，每个进程完成不同的功能。面向用户的接口是 REST API，不过 nova 内部组件都是通过 RPC 消息传递机制进行交流的。    

API 服务器处理 REST 请求，通常这些请求涉及到数据库的读写，不过也可能包含发送 RPC 消息给其他 Nova 服务，并生成对 REST 调用的相应。RPC 消息是通过 **oslo.messaging** 库完成的，这个库对顶层消息队列进行了抽象。大部分的 nova 组件能够运行在多个服务器上，并且有个 _manager_ 来监听 RPC 消息。唯一特殊的是 nova-compute，这个单一进程是运行在其管理的 hypervisor 上的。   

Nova 同样也使用了一个集中式的数据库来和其他所以组件共享数据。    

### API Guide

通过 Compute API，该服务提供了大量可伸缩，按需分配，自助访问的计算资源。取决于部署的方式，这些计算资源可能是虚拟机，物理机或者容器。    

Compute API使用 Keystone 中间件识别出的用户角色和 oslo.policy 结合来决定用户可以被授权做什么。    
虽然 policy 可以通过标准方式配置，但是我们还是建议标准化以下类型的用户：   

+ 应用的部署者：创建/删除服务器，直接或者间接通过 API
+ 应用的开发者：创建在云上运行的镜像和应用
+ 云的管理员：部署，操作和维护云     

#### Versions

OpenStack Compute API 同时使用了 URI 和 MIME 类型两种版本模式。在 URI模式中，路径的第一部分包含了目标版本的标志符。MIME 模式上使用了 HTTP 内容协商，`Accept` 或者 `Content-Type` 首部会包含用来标志版本的 MIME 类型，同时也会包含一个基础的 MIME 类型。如果同时使用两种模式产生了冲突，URI 的优先级更高。    

使用 MIME 类型版本号的例子：   

```http
GET /214412/images HTTP/1.1
Host: servers.api.openstack.org
Accept: applcation/vnd.openstack.compute.v2.1+json
X-Auth-Token: eaaafd18-0fed-4b3a-81b4-663c99ec1cbb
```    

使用 URI 例子：   

```http
GET /v2.1/214412/images HTTP/1.1
Host: servers.api.openstack.org
Accept: application/json
X-Auth-Token: eaaafd18-0fed-4b3a-81b4-663c99ec1cbb
```  

#### API 的核心理念

为了能有效地使用 Compute API，客户需要理解以下的几个关键理念：    

+ **Server**   
一个虚拟机实例，物理机或者是计算系统中的一个容器。配置和镜像是创建一个服务器所必须的元素，服务器的名字同样也是。    

+ **Flavor**   
所要求的服务器的虚拟硬件配置。每种配置都是硬盘空间，内存容量和CPU 时间优先级的独特结合。    

+ **Flavor Extra Specs**   
略。文档未完成。   

+ **Image**  
用来创建或者重新构建一个服务器的文件的集合。默认情况下，云服务提供商可能会提供多种预构建了的系统镜像。当然我们
也可以从我们启动的云服务器上创建定制的镜像。     

+ **Image Properties**   
略。文档未完成。    

+ **Key Pair**    
在服务器启动时可以注入一个 ssh 或者 x509 的密钥对。这样的话，在服务器创建后再连接服务器时我们就不需要密码了。    

+ **Volume**    
Nova 可以使用一个块存储设备做永久存储。当创建一个服务器的时候其本身会有一些可用的磁盘存储空间，但是这些空间被
认为只是暂时的，当服务器被摧毁时磁盘也就被摧毁了。因此可以绑定给服务器一个云磁盘，之后我们可以将其解绑并绑定到另一个服务器上。云磁盘是通过 Cinder 服务创建和管理的。    

+ **Quotas**   
任意独立用户可消费的资源量的上限值。配额可以用来限制一个客户创建的服务器的数量或者是使用磁盘空间的量。改变配额值是一个管理员级别的行为。     

+ **Rate Limiting**   
略。    

+ **Avaliability zone**    
用来控制新创建服务器位置的一组主机。

同时，管理员需要理解下面的理念。因为一些 API 主要侧重用 Nova 的管理，并且一般侧重与计算主机（应该是指跑计算服务的主机）而不是服务器。     

+ **Services**    
服务是Nova 组件提供的。一般来说，，Nova 组件以进程的形式运行在 controller/compute 节点上来提供服务。
