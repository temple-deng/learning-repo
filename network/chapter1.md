# 第 1 章 计算机网络和因特网

## 1.1 什么是因特网

### 1.1.1 具体描述构成

所有可以与因特网连接的设备都被称为主机或者端系统。端系统通过通信链路和分组交换机连接到一起。有很多类型的通信链路，它们由不同类型的物理媒体组成，这些物理媒体包括同轴电缆、铜线、光纤和无线电频谱。    

两种最著名类型的分组交换机是路由器和链路层交换机。链路层交换机通常用于接入网中，而路由器通常用于网络核心中。     

## 1.2 网络边缘

### 1.2.1 接入网

接入网指将端系统连接到其边缘路由器的物理链路。边缘路由器是端系统到任何远程系统的路径上的第一台路由器。下面介绍的是几种不同类型的接入链路和使用接入网的环境。    

**1. 家庭接入：DSL、电缆、FTTH、拨号和卫星**     

宽带住宅接入通常有两种：数字用户线(Digital Subscriber Line, DSL)和电缆。每个用户的 DSL 调制解调器使用现有的电话线与位于本地电话公司的本地中心局的数字用户线接入复用器来交换数据。在用户一侧，一个分频器把到达家庭的数据信号和电话信号分隔开来，并把数字信号转发给 DSL 调制解调器。   

电缆因特网接入利用了有线电视的基础设施。     

光纤到户(Fiber To The Home, FTTH) 是新兴的技术，从本地中心局直接到家庭提供一条光纤。不过一般情况是，从中心局出来到达每根光纤实际上由许多家庭共享，直到相对接近这些家庭的位置，该光纤才分成每户一根光纤。进行这种划分的有两种竞争性的光纤分布体系结构：主动光纤网络(Active Optical Network, AON)和被动光纤网络(Passive Optical Network, PON)。    

简单介绍以下PON，每个家庭具有一根光纤网络端接器(Optical Network Terminator, ONT)，它由专门的光纤连接到临近的分配器。该分配器把一些家庭集结到一根共享的光纤，该光纤再连接到本地电话公司和公司中心局中的光纤先略端接器(Optical Line Termiantor, OLT)。该OLT提供了光信号和电信号之间的转换，经过路由器与互联网相连。   

**2. 企业（和家庭）接入：以太网和 WiFi**     

在公司和大学及越来越多的家庭环境中，通常是局域网(LAN)将端用户连接到边缘路由器，以太网是目前最流行的局域网接入技术。以太网用户使用双绞铜线与一台以太网交换机相连，交换机则再与互联网相连。     

**3. 广域无线网接入：4G**   

移动设备通过蜂窝网提供商运营的基站来发送接受分组。与WiFi不同的是，一个用户仅需要位于基站的数万米范围内。    

### 1.2.2 物理媒体

物理媒体可具有多种形状和形式，分为两类：导引型媒体和非导引型媒体。对于导引型媒体，电波沿着固体媒体前行，如光缆、双绞铜线或同轴电缆。对于非导引型媒体，电波在空气或外层空间中传播，例如在无线局域网或卫星中。     

**1. 双绞铜线**     

最为普遍的导引型媒体就是双绞铜线。双绞线由两个隔离的铜线组成，以规则的螺旋形式排列着。这两根线被绞合起来，以减少来自邻近类似的双绞线的电气干扰。通常许多双绞线捆扎在一起形成一根电缆，并在这些双绞线外面覆盖上保护性防护层。无屏蔽双绞线(Unshielded Twisted Pair, UTP)通常用于无线网中。     

**2. 同轴电缆**    

与双绞线类似，同轴电缆也是两个铜导体组成，但是这两个导体是同心的。借助于这种结构及特殊的绝缘体和保护层，同轴电缆能够达到较高的数据传输速率。    

**3. 光纤**    

光纤是一种细而柔软的、能够引导光脉冲的媒体，每个脉冲表示一个比特。一根光纤能够支持极高的比特速率。    

**4. 陆地无线电信道**    

无线电信道承载了电磁频谱中的信号。它不需要安装物理链路，并能穿透墙壁。    

陆地无线电信道能够大致分为三类：一类运行在很短距离，例如1米或2米，另一类运行在局域，通常跨域几十米，第三类运行在广域，跨域数万米。     

**5. 卫星无线电信道**    

一颗通信卫星连接两个或多个位于地球的微波发射方/接收方，它们被称为地面站。     

## 1.3 网络核心

### 1.3.1 分组交换

**1. 存储转发传输**     

多数分组交换机在链路的输入端使用存储转发传输机制。即在交换机能够开始向输出链路传输该分组的第一个比特之前，必须接收到整个分组。     

**2. 排队时延和分组丢失**    

每个分组交换机有多条链路与之相连。对于每条相连的链路，交换机都有一个输出缓存，也叫输出队列，用于存储路由器准备发往那条链路的分组。    

**3. 转发表和路由选择协议**    

当一个分组到达网络中的路由器（交换机就不行么？）时，路由器检查该分组目的IP地址的一部分，并向一台相邻路由器转发该分组。更特别的是，每个路由器具有一个转发表，用于将目的地址（或目的地址的一部分）映射成输出链路。     

### 1.3.2 电路交换

通过网络链路和交换机移动数据有两种基本方法：电路交换和分组交换。    

在电路交换网络中，在端系统间通信会话期间，预留了端系统间通信沿路径所需要的资源，在分组交换网络中，则是不预留的。    

**1. 电路交换网络中的复用**    

链路中的电路是通过**频分复用**(Frequency-Division Multiplexing, FDM)或**时分复用**(Time-Division Mulitplexing, TDM)来实现的。对于FDM，链路的频谱由跨越链路所创建的所有连接共享。特别是，在连接期间为每条连接专用一个频段。对于一条TDM链路，时间被划分为固定区间的帧，并且每帧又被划分为固定数量的时隙。当网络跨越一条链路创建一条链接时，网络在每个帧中为该连接指定一个时隙。    

## 1.5 协议层次及其服务模型

### 1.5.1 分层的体系结构

各层的所有协议被称为协议栈。因特网的协议栈由5个层次组成：物理层，链路层，网络层，传输层，应用层。    

1. 应用层    
端系统中的应用程序使用协议与另一个端系统中的应用程序交换信息的分组。位于应用层的信息分组称为报文。    
2. 传输层     
传输层在应用程序端点之间传送应用层报文，有两个传输层协议，TCP和UDP。传输层分组称为报文段。     
3. 网路层     
网络层负责将称为数据报的网络层分组从一台主机移动到另一台主机。    
4. 链路层    
链路层分组称为帧。    
5. 物理层   
略。    

### 1.5.2 封装

链路层交换机实现了第一层和第二层，路由器实现了第一层到第三层。因此，路由器能够实现IP协议，而链路层交换机不能。不过，尽管链路层交换机不能识别IP地址，但能够识别第二层地址，如以太网地址。那也就是说，链路层交换机一般应该只能用于局域网内，无法用于广域网中。     


# 第 2 章 应用层

## 2.1 应用层协议原理

### 2.1.1 网络应用程序体系结构

两种主流的应用程序体系结构——客户-服务器体系结构，对等(P2P)体系结构。感觉这里它说的有问题，看样子，他把B/S架构划分到C/S架构中了。     

在一个 P2P 体系结构中，对位于数据中心的专用服务器有最小的依赖。相反，应用程序在间断连接的主机对之间使用直接通信，这些主机被称为对等方。    

### 2.1.2 进程通信

进程通过一个称为套接字的软件接口向网络发送报文和从网络接收报文。套接字是同一台主机内应用层与传输层直接的接口。由于该套接字是建立网络应用程序的可编程接口，因此套接字也称为应用程序和网络之间的应用程序编程接口(API)。应用程序开发者可以控制套接字在应用层端的一切，但是对于套接字在传输层端几乎没有控制权。应用程序开发者对与传输层的控制仅限于：1.选择传输层协议。2，也许能设定几个传输层参数，如最大缓存和最大报文段长度。   

### 2.1.3 可供应用程序使用的运输服务

应用程序对传输层提供的服务要求可大致分为4种类型：可靠数据传输、吞吐量、定时和安全性。    

**1. 可靠数据传输**    

如果一个传输层协议可以确保由应用程序的一端发送的数据正确、完全地交付给应用程序的另一端，就可以认为协议提供了可靠数据传输。如果一个协议提供这种服务，发送进程只要将其数据传递给套接字，就可以完全相信数据能无差错地到达接收进程。     

**2. 吞吐量**    

传输层协议能够以某种特定的速率提供确保的可用吞吐量。        

**3. 定时**    

传输层协议提供定时保证，例如保证发送方注入到套接字的数据到达接收方的时间不超过100ms。   

**4. 安全性**    

传输层协议能够为应用程序提供一种或多种安全性服务。例如可以加密传输的所有数据，还可以提供例如数据完整型和端点鉴别等安全性服务。     

### 2.1.4 因特网提供的传输服务

因特网为应用程序提供了两个传输层协议，即 UDP 和 TCP。    

**1. TCP**    

TCP 服务模型包括面向连接服务和可靠数据传输服务。当某个应用程序调用 TCP 作为其运输协议时，该应用程序就能获得来自 TCP 的这两种服务。    

+ _面向连接的服务_：在应用层数据报文开始流动之前，TCP让客户和服务器互相交换传输层控制信息。在握手阶段后，一个 TCP 连接就在两个进程的套接字之间建立了。这条连接是全双工的，即连接双方的进程可以在此连接上同时进行报文转发。
+ _可靠数据传输服务_：通信进程能够依靠 TCP，无差错、按适当顺序交付所有发送的数据。    

**2. UDP**   

UDP 是一种不提供不必要服务的轻量级传输协议，它仅提供最小服务。UDP 是无连接的，因此在两个进程通信前没有握手过程。UDP 也没有包括拥塞控制机制。   

**3. 因特网传输信息不能提供的服务**    

虽然今天的因特网通常能够为时间敏感的应用提供满意的服务，但不能提供任何定时和带宽即吞吐量的保证。     

### 2.1.5 应用层协议

应用层协议定义了运行在不同端系统上的应用程序进程如何相互传递报文，特别是应用层协议定义了：   
+ 交换的报文类型，如请求报文和响应报文
+ 各种报文类型的语法，如报文中各个字段
+ 字段的语义
+ 一个进程何时以及如何发送报文，对报文进行响应的规则     

有些应用层协议是由 RFC 文档定义的，因此他们位于公共域中，例如HTTP，还有很多别的应用层协议是专用的，不为公共域使用。    

## 2.3 文件传输协议：FTP

在一个典型的 FTP 会话中，用户坐在一台主机前，向一台远程主机传输（或者接收来自远程主机）的文件。为了使用户能访问它的远程账户，用户必须提供用户标识和口令。用户通过一个 FTP 用户代理与 FTP 交互。用户先提供远程主机的主机名，使本地主机的 FTP 客户进程建立一个到远程主机 FTP 服务器进程的 TCP 连接。    

FTP 使用了两个并行的TCP连接来传输文件，一个是控制连接，一个是数据连接。控制连接用于在两主机之间传输控制信息，如用户标识、口令、改变远程目录的命令及“存放”和“获取”文件的命令。数据连接用于实际发送一个文件。     

当用户主机与远程主机开始一个 FTP 会话时，FTP 客户端首先在服务器 21号端口与服务器端发起一个用于控制的 TCP 连接。FTP 的客户端也通过该控制连接发送用户的标识和口令。当 FTP 的服务器端从该连接上收到一个文件传输的命令后（无论是向还是来自远程主机），就发起一个客户端的 TCP 数据连接。FTP 在该数据连接上准确地传送一个文件，然后关闭连接。在同一个会话期间，如果用户还需要传输另一个文件，FTP 则打开另一个数据连接。因而对于 FTP 传输而言，控制连接贯穿了整个用户会话周期，但是对会话中的每一次文件传输都需要建立一个新的数据连接。    

FTP 服务器必须在整个会话期间保留用户的状态，特别是，服务器必须把特定的用户账户与控制连接联系起来，随着用户在远程目录树上徘徊，服务器必须追踪用户在远程目录树上的当前位置。     

从客户到服务器的命令和从服务器到客户的回答，都是以7比特 ASCII 格式在控制连接上传送的。为了区分连续的命令，每个命令后跟回车换行符。每个命令由4个大写字母 ASCII字符组成，有些还具有可选参数。一些常见的命令如下：    

+ USER username：用于向服务器传送用户标识
+ PASS password：用于向服务器传送口令
+ LIST：用于请求服务器回送当前远程目录中的所有文件列表。该列表是在数据连接上传送的。
+ RETR filename：用于从远程主机当前目录检索文件，该命令引起远程主机发起一个数据连接，并经该连接发送请求的文件
+ STOR filename：用户在远程主机的当前目录上存放文件    

用户发出的命令和 FTP 发送的命令之间通常有一一对应关系。每个命令都对应着一个从服务器发向客户的回答。回答是一个3位的数字，后跟一个可选信息，典型的回答如下：    
+ 331 Username OK, Password required
+ 123 Data Connection already open; transfer starting
+ 425 Can't open data connection
+ 452 Error writing file    

## 2.4 电子邮件

电子邮件系统有3个主要组成部分：用户代理，邮件服务器和简单邮件传输协议(Simple Mail Transfer Protocol, SMTP)。    

一个典型的邮件发送过程是：从发送方的用户代理开始，传输到发送方的邮件服务器，再传输到接收方的邮件服务器，然后在这里被分发到接收方的邮箱中。     

SMTP 是电子邮件中主要的应用层协议，它使用 TCP 可靠传输服务，从发送方的邮件服务器向接收方的邮件服务器发送邮件。像大部分应用层协议一样，SMTP 也有两个部分：运行在发送方邮件服务器的客户端和运行在接收方邮件服务器的服务器端。每台邮件服务器上即运行 SMTP 客户端也运行 SMTP 的服务器端。    

### 2.4.1 SMTP


为了描述 SMTP 的基本操作，我们观察一种常见的情景。假设 A 想给 B 发送一封简单的 ASCII 报文。    

+ A 调用其邮件代理程序并提供 B 的邮箱地址，撰写报文，然后指示用户代理发送该报文。
+ A 的用户代理把报文发给它等等邮件服务器，在那里该报文被放在访问队列中。
+ 运行在 A 邮件服务器上的 SMTP 客户端发现了报文队列中的这个报文，它就创建一个到运行在 B 邮件服务器上的 SMTP 服务器的 TCP 连接。
+ 在经过一些初始 SMTP 握手后，SMTP客户端通过该 TCP 连接发送 A 的报文。
+ 在 B 的邮件服务器上，SMTP 的服务器端接收到该报文。B 的邮件服务器然后将该报文放入 B 的邮箱中。
+ 在B 方便的时候，他调用用户代理阅读该报文。    

SMTP 一般不是使用中间邮件服务器发送邮件，即使这两个邮件服务器位于地球的两端，如果B 的邮件服务器未开机，该报文会保留在 A 的邮件服务器上并等待进行新的尝试。    

SMTP 要求每个报文使用7比特ASCII码格式。如果某报文包含了非7比特ASCII字符或二进制数据，则该报文必须按照7比特ASCII码进行编码。    

### 2.4.3 邮件报文格式和 MIME

一个人给另一个人发送电子邮件时，一个包含环境信息的首部位于报文体前面。这些环境信息包括在一系列首部行中，这些行
由 RFC 5322 定义。首部行和该报文的体用空行（即回车换行）进行分隔。RFC 5322 定义了邮件首部行和它们的语义解释的精确格式。如同 HTTP 协议，每个首部行包含了可读的文本，是由关键词后跟冒号即其值组成的。某些关键词是必需的，
另一些则是可选的。每个首部必须含有一个 From: 首部行和一个 To: 首部行，一个首部也许可以包含一个 Subject: 首部行以及其他可选的首部行。   

```
From: alica@crepes.fr
To: bob@hamburger.edu
Subject: Searching for the meaning of life.
```   

### 2.4.4 邮件访问协议

在前面的例子中，B 的用户代理不能使用 SMTP 取回报文，因为取报文是一个拉操作，而SMTP 是一个推协议。通过引入一个特殊的邮件访问协议来解决这个难题，该协议将B 邮件服务器上的报文传送给他的本地 PC。目前有一些流行的邮件访问协议，包括第三版的邮局协议(Post Office Protocol-Version 3, POP3)、因特网邮件访问协议(Internet Mail Access Protocol, IMAP)以及HTTP。    

**1. POP3**   

当用户代理打开了一个到邮件服务器端口110上的TCP连接后，POP3就开始工作了。随着建立 TCP 连接，POP3按照三个阶段进行工作：身份认证、事务处理已经更新。在第一阶段，用户代理发送用户名和口令以鉴别用户。在第二阶段，用户代理取会报文，
同时在这个阶段用户代理还能进行如下操作，对报文做删除标记，取消报文删除标记，已经获取邮件的统计信息。在第三个阶段，它出现在客户发出了 quit 命令之后，目的是结束该 POP3 会话，这时，该邮件服务器删除那些被标记为删除的报文。    

其他的就先略了。    

## 2.5 DNS

### 2.5.1 DNS 提供的服务

人们喜欢使用主机名的标识方式，而路由器则喜欢定长的、有着层次结构的 IP 地址。因此我们需要一种能进行主机名到 IP 地址转换的目录服务。这就是域名系统(Domain Name System, DNS)的主要任务。DNS 是：1.一个由分层的 DNS 服务器实现的分布式数据库,2.一个使得主机能够查询分布式数据库的应用层协议。DNS 服务器通常是运行 BIND 软件的 UNIX 机器。DNS 协议运行在 UDP 之上，使用 53号端口。   

一个使用 DNS 的典型过程如下：   

+ 一台用户主机上运行者 DNS 应用的客户端
+ 浏览器从上述 URL 中抽取出主机名 www.someschool.edu，并将这台主机名传给 DNS应用客户端
+ DNS 客户端向 DNS 服务器发送一个包含主机名的请求
+ DNS 客户最终会收到一份回答把我，其中含有对应与该主机名的 IP 地址
+ 一旦浏览器接收到来自 DNS 的该 IP 地址，它能够向位于该 IP 地址 80 端口的 HTTP 服务器进程发起一个 TCP 连接     

除了进行主机名到 IP 地址的转换外，DNS还提供了一些重要的服务：   

+ 主机别名。有着复杂主机名的主机能拥有一个或者多个别名。
+ 邮件服务器别名。
+ 负载分配。DNS 也用于在冗余的服务器之间进行负载分配。繁忙的站点被冗余分别在多条服务器上，每台服务器均运行在不同的端系统上，每个都有着不同的 IP 地址。由于这些冗余的 Web 服务器，一个 IP 地址集合因此与同一个规范主机名相联系。当客户对映射到某地址集合的名字发出一个 DNS 请求时，该服务器用 IP 地址的整个集合进行响应，但在每个回答中循环这些地址次序。因为客户端通常总是向 IP 地址排在最前面的服务器发送 HTTP 请求报文。    

### 2.5.2 DNS 工作机理概述

**1. 分布式、层次数据库**     

DNS 使用了大量的 DNS 服务器，它们以层次方式组织，并且分布在全世界范围内。没有一台 DNS 服务器拥有因特网上所有主机的映射。相反，该映射分布在所有的DNS 服务器上。大致说来，有3种类型的DNS 服务器：根 DNS 服务器、顶级域 DNS 服务器和权威 DNS 服务器。为了理解这3种类型的 DNS 服务器的交互方式，假定一个用户决定要 www.amazon.com 的 IP 地址。粗略说来，将发生以下事件。客户首先与根服务器之一联系（这意思就是根服务器也有多个咯，那根服务器之间怎么交流），它将返回顶级域名 com 的顶级域名服务器的 IP 地址。该客户则与这些顶级域服务器之一联系（这个意思是根级返回了多个顶级域的地址咯），它将为 amazon.com 返回权威服务器的 IP 地址。最后，该客户与 amazon.com 权威服务器之一联系（说明还是返回了多个），它为主机名 www.amazon.com 返回其 IP 地址。    

我们先介绍一下这3种类型的服务器：    

+ **根 DNS 服务器**。在网上有13个根 DNS 服务器，标号为 A到 M，它们中的大部分位于北美洲。当然，虽然说是13个
服务器，但是其实每个服务器都是一个冗余服务器的网络。实际数量可能远多于 13 个。
+ **顶级域 DNS 服务器**。这些服务器负责顶级域名如 com、org、net、edu和 gov，以及所有国家的顶级域名如 uk、fr、ca和 jp。
+ **权威 DNS 服务器**。在因特网上具有公共可访问主机的每个组织机构必须提供公共可访问的 DNS 记录，这些记录将这些主机的名字映射为 IP 地址。一个组织机构的权威 DNS 服务器收藏了这些 DNS 记录。一个组织机构能够选择实现它自己的权威 DNS 服务器以保存这些记录；另一种方法是该组织支付费用，让这些记录存储在某个服务提供商的DNS 服务器上。    

除了以上3类服务器外，还有一类叫做本地 DNS 服务器。通常来说这个服务器是 ISP 提供的。    

**2. DNS 缓存**    

实际上，为了改善时延性能并减少在网上到处传输的 DNS 报文数量，DNS 广泛使用了缓存技术。DNS 缓存的原理非常简单。在一个请求链中，当某 DNS 服务器收到一个 DNS 回答，它能将该回答中的信息缓存到本地存储器中。    

### 2.5.3 DNS 记录和报文

共同实现 DNS 分布式数据库的所有 DNS 服务器存储了资源记录(Resource Record, RR)，RR提供了主机名到 IP 地址的映射。每个 DNS 回答报文包含了一条或多条资源记录。    

资源记录是一个包含了下列字段的4元组：   

(Name, Value, Type, TTL)    

TTL 是该记录的生存时间，它决定了资源记录应当从缓存中删除的时间。Name 和 Value 的值取决于 Type:    

+ 如果 Type = A，则 Name 是主机名，Value就是该主机名对应的 IP 地址，例如 (relay1.bar.foo.com, 145.37.93.126, A)就是一条类型A记录（这里忽略掉 TTL）
+ 如果 Type = NS，则 Name 是个域（如 foo.com），而 Value 是个知道如何获得该域中主机 IP 地址的权威 DNS 服务器的主机名。这个记录用于沿着查询链来路由 DNS查询，例如(foo.com, dns.foo.com, NS)
+ 如果 Type = CNAME，则 Value 是别名为 Name 的主机对应的规范主机名。该记录能够向查询的主机提供一个主机名对应的规范主机名
+ 如果 Type = MX，则 Value 是个别名为 Name 的邮件服务器的规范主机名    

**1. DNS 报文**    

DNS 只有查询和回答两种报文，两种有着相同的格式，如图所示：    



