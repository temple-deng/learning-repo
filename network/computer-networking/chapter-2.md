# 第二章 应用层

<!-- TOC -->

- [第二章 应用层](#第二章-应用层)
  - [2.1 应用层协议原理](#21-应用层协议原理)
    - [2.1.1 网络应用程序体系结构](#211-网络应用程序体系结构)
    - [2.1.2 进程通信](#212-进程通信)
    - [2.1.3 可供应用程序使用的运输服务](#213-可供应用程序使用的运输服务)
    - [2.1.4 因特网提供的传输服务](#214-因特网提供的传输服务)
    - [2.1.5 应用层协议](#215-应用层协议)
  - [2.2 Web 和 HTTP](#22-web-和-http)
    - [2.2.2 非持续连接和持续连接](#222-非持续连接和持续连接)
  - [2.3 文件传输协议：FTP](#23-文件传输协议ftp)
  - [2.4 因特网中的电子邮件](#24-因特网中的电子邮件)
    - [2.4.1 SMTP](#241-smtp)
    - [2.4.3 邮件报文格式和 MIME](#243-邮件报文格式和-mime)
    - [2.4.4 邮件访问协议](#244-邮件访问协议)
  - [2.5 DNS：因特网的目录服务](#25-dns因特网的目录服务)
    - [2.5.1 DNS 提供的服务](#251-dns-提供的服务)
    - [2.5.2 DNS 工作机理概述](#252-dns-工作机理概述)
    - [2.5.3 DNS 记录和报文](#253-dns-记录和报文)
  - [2.6  P2P 应用](#26--p2p-应用)
    - [2.6.1 P2P 文件分发](#261-p2p-文件分发)

<!-- /TOC -->

## 2.1 应用层协议原理

### 2.1.1 网络应用程序体系结构

应用程序体系结构由应用程序研发者设计，规定了如何在各种端系统上组织该应用程序。在选择应用程序体系结构时，
应用程序研发者很可能利用现代网络应用程序中使用的两种主流体系结构之一：客户——服务器体系结构或对等（P2P)体系结构。    

在一个 P2P 体系结构中，对位于数据中心的专用服务器有最小的依赖。相反，应用程序在间断连接的主机对
之间使用直接通信，这些主机对被称为 **对等方**。     

P2P 体系结构最引人入胜的特性之一是它们的 **自扩展性**。例如，在一个 P2P 文件共享应用中，
尽管每个对等方都由于请求文件产生工作量，但每个对等方通过向其他对等方分发文件也系统增加
服务能力。    

### 2.1.2 进程通信

我们定义客户和服务器进程如下：在给定的一对进程之间的通信会话场景中，发起通信的进程被标识为客户，
在会话开始时等待联系的进程是服务器。    

多数应用程序是由通信进程对组成，每对中的两个进程互相发送报文。从一个进程向另一个进程发送的
报文必须通过下面的网络。进程通过使用一个称为 **套接字** 的软件接口向网络发送报文和从网络接收报文。
也就说，其实应用程序是使用套接字连入下层的网络。   

套接字是一台主机内应用层和传输层之间的接口。由于该套接字是建立网络应用程序的可编程接口，
因此套接字也被称为应用程序和网络之间的 **应用程序变成接口**（API）。应用程序开发者可以
控制套接字在应用层端的一切，但是对该套接字的传输层几乎没有控制权。应用程序开发者对于
传输层的控制仅限于：1. 选择传输层协议。2. 也许能设定几个运输层参数，如最大缓存和最大报文段长度。   

在一条主机上运行的进程为了向在另一台主机上运行的进程发送分组，接收进程需要有一个地址。为了标识该接收进程，
需要定义两种信息：1.主机的地址。2. 定义在目的主机中的接收进程的标识符。就是 IP 地址和端口号啦。    

### 2.1.3 可供应用程序使用的运输服务

一个运输层协议能够为调用它的应用程序提供什么样的服务呢？我们大体能够从四个方面对应用程序服务要求进行分类：
可靠数据传输、吞吐量、安全和定时。     

1. 可靠数据传输。如果一个协议能够确保由应用程序一端发送的数据正确、完全地交付给该应用程序的另一端，就认为提供
了可靠数据传输。
2. 吞吐量。吞吐量就是发送进程向接收进程交付比特的速率。具有吞吐量要求的应用程序被称为带宽敏感的应用。
3. 定时。
4. 安全性。传输层协议能够提供例如机密性、数据完整性和端点鉴别等安全性服务。    

### 2.1.4 因特网提供的传输服务

前面讲的其实是，应用程序可能对服务提出的要求，而这一节讲的是因特网传输层协议能为应用程序
提供的服务。因特网为应用程序提供了两个传输层协议，即 UDP 和 TCP。    

1. **TCP 服务**    

TCP 服务模型包括面向连接服务和可靠数据传输服务。这是 TCP 可以提供的两个服务。    

+ 面向连接的服务。在应用层数据报文开始流动之前，TCP 让客户和服务器互相交换传输层控制信息。这个所谓
的握手过程提示客户和服务器，使它们为大量分组的到来做好准备。在握手阶段后，一个 **TCP 连接** 就在两个
进程的套接字间建立了。这条连接是全双工的，即连接双方的进程可以在此连接上同时进行报文收发。当应用程序结束
报文发送时，必须拆除该连接。
+ 可靠数据传输服务。通信进程能够依靠TCP，无差错、按适当顺序交付所有发送的数据。当应用程序一端
将字节流传进套接字时，它能够依靠 TCP 将相同的字节流交付给接收方的套接字，而没有字节的丢失和冗余。    

TCP 协议还具有拥塞控制机制，但是这种服务并不是提供给应用程序的，而是为整个因特网带来好处。   

2. **UDP服务**    

UDP 是无连接的，因此在两个进程通信前没有握手过程。UDP 协议提供一种不可靠数据传送服务，不保证将
报文送到接收进程。   

UDP 没有包括拥塞控制机制，所以 UDP 的发送端可以用它选定的任何速率向其下层注入数据。    

无论是 TCP 还是 UDP 都没有提供任何加密机制，因此因特网界研制了 TCP 的加强版本，称为 **安全套接字层**
（Secure Socket Layer, SSL）。SSL 提供了关键的进程到进程的安全性服务，包括加密、数据完整性和端点鉴别。
SSL 是在应用层运行的协议。SSL 有它自己的套接字 API，这类似于传统的 TCP 套接字 API。当一个
应用使用 SSL 时，发送进程向 SSL 套接字传递明文数据；在发送主机中的 SSL 则加密该数据并将加密的数据传递给 TCP
套接字。     

3. **因特网传输协议不提供的服务**    

TCP 和 UDP都没有提供对吞吐量和定时保证的讨论，即这些服务目前的因特网传输协议并没有提供。    


### 2.1.5 应用层协议

如何构造应用层报文？这些报文中各个字段是什么意思？进程如何发送这些报文？这些都是应用层协议需要去定义的，
应用层协议定义了：    

+ 交换的报文类型，例如请求报文和响应报文。
+ 各种报文类型的语法，如报文中各个字段以及这些字段是如何描述的。
+ 字段的语义，即这些字段中包含的信息的含义。
+ 一个进程何时以及如何发送报文，对报文进行响应的规则。    

有些应用层协议是由 RFC 文档定义的，因此它们位于公共域中，也有很多应用层协议是专用的，不为公共域使用。    

## 2.2 Web 和 HTTP

### 2.2.2 非持续连接和持续连接

因为 HTTP 服务器并不保存关于客户的任何信息，所以我们说 HTTP 是一个 **无状态协议**。   

这里需要注意，是无状态协议，而不是无连接的协议，很明显 HTTP 底层的 TCP 是提供连接的。   

在许多应用程序中，客户和服务器在一个相当长的时间范围内通信，其中客户发出一系列请求并且服务器对每个请求进行响应。
依据应用程序以及该应用程序的使用方式，这一系列请求可以以规则的间隔周期性地或者间断地一个接一个发出。当这种
客户-服务器的交换是经 TCP 进行的，应用程序的研制者就需要做一个重要决定，即每个请求/响应对是经一个
单独的 TCP 连接发送，还是所有的请求及其响应对经相同的 TCP 连接发送。前一种方法，就是非持续连接的方式，
后一种方法，就是持续连接的方式。    

剩下的没什么好说的，都知道了。    

## 2.3 文件传输协议：FTP

在一个典型的 FTP 会话中，用户坐在本地主机前，向一台远程主机传输（或接收来自远程主机的）文件。为使用户能访问它
的远程账户，用户必须提供一个用户标识和口令。用户通过一个 FTP 用户代理与 FTP 交互。    

FTP 使用了两个并行的 TCP 连接来传输文件，一个是 **控制连接**，一个是 **数据连接**。控制连接用于在两主机之间
传输控制信息，如用户标识、口令、改变远程目录的命令以及“存放”和“获取”文件的命令。数据连接用于实际发送一个文件。
因为 FTP 协议使用一个独立的控制连接，所以我们也称 FTP 的控制信息是 **带外**传送的。    

当用户主机与远程主机开始一个 FTP 会话时，FTP 的客户端首先在服务器 21 号端口与服务器发起一个用于控制的 TCP 连接。
FTP 客户端也通过该控制连接发送用户的标识和口令，发送改变远程目录的命令。当 FTP 的服务器端从该连接上收到一个
文件传输的命令后，就发起一个到客户端的 TCP 数据连接。FTP 在该数据连接上准确地传送一个文件，然后关闭该连接。在
同一个会话期间，如果用户还要传输另一个文件，FTP 则打开另一个数据连接。因而对于 FTP 传输而言，控制连接贯穿了
整个用户会话期间，但是对会话中的每一次数据传输都要建立一个新的数据连接。注意上面没说数据连接是在哪个端口，
服务器的话通常是端口 20，客户端的话不定。        

FTP 服务器必须在整个会话期间保留用户的状态。    

从客户到服务器的命令和从服务器到客户的回答，都是以7比特 ASCII 格式在控制连接上传送的。为了区分连续的命令，每个命令
后跟回车换行符。每个命令由4个大写字母 ASCII 字符组成，有些还具有可选参数。一些较为常见的命令如下：   

+ USER username：用于向服务器传送用户标识。
+ PASS password：用于向服务器发送用户口令。
+ LIST：用于请求服务器回送当前远程目录中的所有文件列表。该文件列表是经一个数据连接传送的，而不是在控制 TCP 连接上传送。
+ RETR filename：用户从远程主机当前目录检索文件。该命令引起远程主机发起一个数据连接，并经该数据连接
发送所请求的文件。RETR 应该是 retrieve 的意思。
+ STOR filename：用于在远程主机的当前目录上存放文件。    

贯穿控制连接，在用户发出的命令和 FTP 发送的命令之间通常有一一对应的关系。每个命令都对应着一个从服务器发向
客户的回答。回答是一个3位的数字，后跟一个可选信息。一些典型的回答连同它们可能的报文如下所示：   

+ 331 Username OK, Password required
+ 125 Data connection already open, transfer starting
+ 425 Can't open data connection
+ 452 Error writing file     

## 2.4 因特网中的电子邮件

电子邮件系统有3个主要的组成部分：**用户代理**、**邮件服务器**和 **简单邮件传输协议**（Simple Mail Transfer Protocol, SMTP）。
用户代理允许用户阅读、回复、转发、保存和撰写报文。当 A 完成邮件撰写时，其邮件代理向其邮件服务器发送邮件，
此时邮件发在邮件服务器的外出报文队列中。    

邮件服务器形成了电子邮件体系结构的核心。每个接收方在其中的某个邮件服务器上有一个 **邮箱**。接收方的邮箱
管理和维护着发送给他的报文。一个典型的邮件发送过程是：从发送方的邮件代理开始，传输到发送方的邮件服务器，再传输
到接收方的邮件服务器，然后在这里分发到接收方的邮箱中。     

如果 A 的服务器不能将邮件交付给 B 的服务器，A的邮件服务器在一个 **报文队列**中保持该报文并在以后尝试
再次发送。通常每30分钟进行一次尝试；如果几天后仍不能成功，，服务器就删除该报文并以电子邮件的形式通知发送方。    

SMTP 是邮件系统中主要的应用层协议。它使用 TCP 可靠数据传输服务，从发送方的邮件服务器向接收方的邮件服务器
发送邮件。像大多数应用层协议一样，SMTP 也有两部分：运行在发送方邮件服务器的客户端和运行在接收方邮件服务器的
服务器端。    


### 2.4.1 SMTP

SMTP 问世的世界要比 HTTP 更早，不过因此其有一些过于老旧的限制，例如，其限制所有邮件报文的体部分（不只是
其首部）只能采用简单的 7 比特 ASCII 表示。因此加入我们有一些多媒体数据，在用 SMTP 传送邮件之前，
需要将二进制多媒体数据编码为 ASCII 码，并且在使用 SMTP 传输后要求将相应的 ASCII 码邮件解码还原为多媒体
数据。     

另外需要注意的一点是，SMTP 一般不使用中间邮件服务器发送邮件。     

首先，客户 SMTP 在25号端口建立一个到服务器 SMTP的 TCP 连接（这个25应该就是服务器的端口吧）。一旦连接
建立，服务器和客户执行某些应用层的握手（注意这里是应用层的握手，而不是 TCP 握手）。
在 SMTP 握手阶段，SMTP 客户只是发送方的邮件地址和接收方的邮件地址。一旦彼此相互介绍之后，
客户发送报文。该客户如果有另外的报文要发送到该服务器，就在相同的 TCP 连接上重复这种处理；
否则，它只是关闭 TCP 连接。    

接下来我们分析一个 SMTP 客户（C）和 SMTP 服务器（S）之间交换报文脚本的例子。客户的主机名为 crepes.fr，
服务器的主机名 hamburger.edu。以 C：开头的 ASCII 码文本行正是客户交给其 TCP 套接字的那些行，以
S 开头的 ASCII 码则是服务器发送给其 TCP 套接字的那些行。一旦创建了 TCP 连接，就开始了下列过程。    

```
S: 220 hamburger.edu （话说怎么是服务器先开始说话）
C: HELO crepes.fr
S: 250 Hello crepes.fr, pleased to meet you
C: MAIL FROM: <alice@crepes.fr>
S: 250 alice@crepes.fr ... Sender ok
C: RCPT TO: <bob@hamburger.edu>
S: 250 bob@hamburget.edu ... Recipient ok
C: DATA
S: 354 Enter mail, end with "." on a line by itself
C: Do you like ketchup?
C: How about pickles?
C: . 
S: 250 Message accepted for delivery
C: QUIT
S: 221 hamburger.edu closing connection
```    

服务器对每条命令做出回答，其中每个回答含有一个回答码和一些（可选的）英文解释。SMTP 使用的是持续连接，
如果发送邮件服务器有几个报文发往用一个接收邮件服务器，它可以通过同一个 TCP 连接发送这些所有的报文。对
每个报文，该客户用一个新的 MAIL FROM： cerpes.fr 开始，用一个独立的句点指示该邮件的结束，并且仅当所有邮件发送完后
才发送 QUIT。    

### 2.4.3 邮件报文格式和 MIME

邮件报文中，一个包含环境信息的首部位于报文体前面。这些环境信息包括在一系列首部行中。首部行和该报文
的主体用空行（即回车换行）进行分隔。如同 HTTP 协议，每个首部行包含了可读的文本，是由关键词后
跟冒号及其值组成的。某些关键词是必需的，另一些则是可选的。每个首部必须含有一个 From: 首部行和
一个 To: 首部行；一个首部也许会包含一个 Subject: 首部行以及其他可选的首部行。一个典型的邮件报文首部
看起来如下：   

```
From: alice@crepes.fr
To: bob@hamburger.edu
Subject: Searching for the meaning of life
```     

其实这里可以看出，SMTP, HTTP, FTP 有一些类似的地方的，比如每条报文其实是可以分成请求
报文和响应报文的，请求报文可能包含一个命令，然后跟着一些可选的参数，响应报文通常有一个数字
响应码，然后跟着一条可能是自定义的消息。然后每条报文，可能附有一些首部行（FTP 好像没有），
首部行和报文主体之间都用一个空行来分割，首部行用来传递一些参数。不过 SMTP 的首部行其实
是与报文一体的。       

### 2.4.4 邮件访问协议

Bob 的用户代理不能使用 SMTP 拉回自己在邮件服务器上的邮件，因为取报文是一个拉操作，而 SMTP 协议是一个
推协议，通过引入一个特殊的邮件访问协议来解决这个难题，该协议将 Bob 邮件服务器上的报文传送给他的本地 PC。
目前有一些流行的邮件访问协议，包括 **第三版的邮局协议**（Post Office Protocol-Version3, POP3）、
**因特网邮件访问协议**（Internet Main Access Protocol, IMAP）以及 HTTP。    

+ **1. POP3**   

POP3 协议非常简单，故其功能有限。当用户代理打开了一个到邮件服务器端口110 上的 TCP 连接后，POP3 就开始
工作了。随着建立 TCP 连接，POP3 按照三个阶段进行工作：特许、事务处理以及更新。在第一个阶段特许阶段，
用户代理发送（以明文形式）用户名和口令以鉴别用户。在第二个阶段即事务处理阶段，用户代理取回报文；同时
在这个阶段用户代理还能进行如下操作，对报文做删除标记，取消报文的删除标记，以及获取邮件的统计信息。在
第三个阶段即更新阶段，它出现在客户发出 quit 指令之后，目的是结束该 POP3 会话；这时，邮件服务器删除
那些被标记为删除的报文。    

+ **2. IMAP**    

IMAP 服务器把每个报文与一个文件夹联系起来；相反，POP3 协议没有给用户提供任何创建远程文件夹并为报文指派
文件夹的方法。当报文第一次到达服务器时，它与收件人的 INBOX 文件夹相关联。收件人则能够把邮件移到一个新的、
用户创建的文件夹中，阅读邮件，删除邮件等。IMAP 协议为用户提供了创建文件夹以及将邮件从一个文件夹移动到另一个
文件夹的命令。IMAP 还为用户提供了在远程文件夹中查询邮件的命令，按指定条件去查询匹配的邮件。    

IMAP 的另一个终于特性是它具有允许用户代理获取报文组件的命令。例如，用户代理可以只读取一个报文的
报文首部，或只是一个多部分 MIME 报文的一部分。    

+ **3. 基于 Web的电子邮件**     

用户代理就是浏览器，用户和他的远程邮箱之间的通信通过 HTTP 进行。     

## 2.5 DNS：因特网的目录服务

### 2.5.1 DNS 提供的服务

识别主机有两种方式，通过主机名或者 IP 地址。人们喜欢便于记忆的主机名标识方式，而路由器则喜欢定长的、
有着层次结构的 IP 地址。为了折中这些不同的偏好，我们需要一种能进行主机名到 IP 地址转换的目录服务。这就是
**域名系统**（Domain Name System，DNS）的主要任务。DNS 是：①一个由分层的 **DNS 服务器** 实现
的分布式数据库。②一个使得主机能够查询分布式数据库的应用层协议。DNS 协议运行在 UDP 之上，使用 53 号端口。    

考虑用户使用浏览器访问 www.someschool.edu/index.html，为了使用户主机能够将一个 HTTP 请求
报文发送到服务器 www.someschool.edu，该用户主机必须能获取主机的 IP 地址，其做法如下：   

+ 同一台用户主机上运行着 DNS 应用的客户端
+ 浏览器从上述 URL 中抽取出主机名 www.someschool.edu，并将这台主机名传给 DNS 应用的客户端
+ DNS 客户向 DNS 服务器发送一个包含主机名的请求
+ DNS 客户最终会收到一份回答报文，其中含有对应于该主机名的 IP 地址
+ 一旦浏览器接收到来自 DNS 的该 IP 地址，它能够向位于该 IP 地址的 80 端口的 HTTP 服务器进程
发起一个 TCP 连接   

除了主机名到 IP 地址ID转换外，DNS 还提供了一些重要的服务：   

+ **主机别名**。有着复杂主机名的主机能拥有一个或者多个别名。通常来说会有一个**规范主机名**。应用程序
可以调用 DNS 来获得主机别名对应的规范主机名以及主机的 IP 地址。
+ **邮件服务器别名**。
+ **负载分配**。DNS 也用于在冗余的服务器之间进行负载分配。这种情况下一个 IP 地址集合因此与同一个
规范主机名相联系。当客户对映射到某地址集合的名字发出一个 DNS 请求时，该服务器用 IP 地址的整个集合
进行响应，但在每个回答中循环这些地址次序。因为客户通常总是向 IP 地址排在最前面的服务器发送 HTTP 请求报文，
所以 DNS 就在这些冗余的服务器之间循环分配了负载。    

### 2.5.2 DNS 工作机理概述

假设运行在用户主机上的某些应用程序需要将主机名转换为 IP 地址。这些应用程序将调用 DNS 的客户端，并指明
需要被转换的主机名。用户主机上的 DNS 接收到后，向网络中发送一个 DNS 查询报文。所有的 DNS 请求和回答
报文使用 UDP 数据报经端口 53 发送。经过若干时延后，用户主机上的 DNS 接收到一个提供所希望映射的 DNS 
回答报文。这个映射结构则被传递到调用 DNS 的应用程序。    

1. **分布式、层次数据库**    

大致来说，有3种类型的 DNS 服务器：根 DNS 服务器、顶级域（Top-Level Domain, TLD）DNS 服务器和权威
DNS 服务器。假定一个用户要决定 www.amazon.com 的 IP 地址。粗略来说，将发生以下事件。客户首先
与根服务器之一联系，它将返回顶级域名 com 的 TLD 服务器的 IP 地址。该客户则与这些 TLD 服务器之一联系，
它将为 amazon.com 返回权威服务器的 IP 地址。最后，客户与 amazon.com 权威服务器之一联系，它将为主机名
www.amazon.com 返回其IP 地址。    

+ **权威 DNS 服务器**。在因特网上具有公共可访问主机的每个组织机构必须提供公共可访问的 
DNS 记录。这些记录将这些主机的名字映射为 IP 地址。一个组织机构的权威 DNS 服务器收藏了
这些 DNS 记录。一个组织机构能够选择实现它自己的权威 DNS 服务器以保存这些记录；另一种方法
是，该组织能够支付费用，让这些记录存储在某个服务器提供商的一个权威 DNS 服务器。    

但是不管哪种方法，你肯定还要把权威服务器的 IP 地址提供给顶级域的服务器。   

除了上述的三种服务器，还有另一类重要的 DNS，称为 **本地 DNS 服务器**。一个本地 DNS 服务器严格来说
并不属于该服务器的层次结构，但它对 DNS 层次结构是重要的。每个 ISP 都有一台本地的 DNS 服务器。当
主机与某个 ISP 连接时，该 ISP 提供一台主机的 IP 地址，该主机具有一台或多台其本地 DNS 服务器的 IP 地址。     

来看一个简单的例子，假设主机 cis.poly.edu 想知道主机 gaia.cs.umass.edu 的 IP 地址。假设
cis.poly.edu 的本地 DNS 服务地址为 dns.poly.edu，并假设 gaia.cs.umass.edu 的权威 DNS
服务器地址为 dns.umass.edu。则过程可能是这样的：   

1. 首先主机向本地 DNS 服务器发送查询报文，请求 gaia.cs.umass.edu 的 IP 地址
2. 本地 DNS 服务器将报文转发到根服务器，根服务器向本地 DNS 服务器返回负责 edu 的 TLD 的 IP 地址列表
3. 本地 DNS 服务器再向这些 TLD 服务器之一发送查询报文，TLD 服务器注意到 umass.edu 前缀，并用
权威服务器的 IP 地址进行响应
4. 最后本地服务器则再向权威服务器 dns.umass.edu 发送查询报文，dns.umass.edu 则用 gaia.cs.umass.edu
的 IP 地址进行响应
5. 最后本地服务器将 IP 地址返回给主机   

注意实际过程中，可能与上面的例子会有出入，典型的情况可能是，用户向本地 DNS 发查询，然后 DNS 再
去向根服务器，顶级服务器和权威服务器发出查询请求，这样最后的结果我们可以缓存在本地 DNS，提供性能。    

### 2.5.3 DNS 记录和报文

共同实现 DNS 分布式数据的所有 DNS 服务器存储了**资源记录**（Resource Record, RR），RR 提供了
主机名到 IP 地址的映射。每个 DNS 回答报文中包含了一条或多条资源记录。    

资源记录是一个包含了下列字段的4 元组： (Name, Value, Type, TTL)。    

TTL 是该记录的生存时间，它决定了资源记录应答从缓存中删除的时间。在下面的例子中，我们先忽略这个值，
Name 和 Value 的值取决于 Type：    

+ 如果 Type = A(address?)，则 Name 是主机名，Value 是该主机名对应的 IP 地址（A 难道是 address）。因此，一条
类型为 A 的资源记录提供了标准的主机名到 IP 地址的映射。
+ 如果 Type = NS(namespace?)，则 Name 是个域（如 foo.com），而 Value 是个指定如何获得该域中主机 IP 地址的权威
DNS 服务器的主机名。这个记录用于沿着查询链来路由 DNS 查询。如(foo.com, dns.foo.com, NS)。话说为什么提供
给个主机名啊，不能直接给 IP 地址嘛。
+ 如果 Type = CNAME，则 Value 是别名为 Name 的主机对应的规范主机名。
+ 如果 Type = MX，则 Value 是别名为 Name 的邮件服务器的规范主机名。   

1. **报文**    

DNS 只有查询和回答这两种报文，查询和回答报文有着相同的格式。报文的结构及字段意思如下：    

@TODO：此处该有图。    

+ 前 12 个字节是首部区域，其中有几个字段。第一个字段（标识符）是一个 16 比特的数，用于标识该查询。
这个标识符会被复制到对查询的回答报文中，以便让客户用它来匹配发送的请求和接收到的回答。标志字段含有
若干标志。1 比特的“查询/回答”标志位指出报文是查询报文（0）还是回答报文（1）。当某 DNS 服务器是所请求
名字的权威服务器时，1 比特的 “权威的” 标志位被置在回答报文中。如果客户在该 DNS 服务器没有某记录时希望它
指定递归查询，将设置 1 比特的“希望递归”标志位。如果该 DNS 服务器支持递归查询，在它的回答报文中会对 1 比特的“递归可用”
标志位置位。但是这也只用了 4 bit 吧，还有 12bit 没介绍含义。在首部中，还有 4个有关数量的字段，
这些字段指出了在首部后的 4 类数据区域出现的数量。   
+ 问题区域包含着正在进行的查询信息。该区域包括：①名字字段，指出正在被查询的主机名字；②类型字段，它指出
有关该名字的正被询问的问题类型，例如主机地址是与一个名字相关联（类型 A）还是与某个名字的邮件服务器相关联（类型 MX）。
+ 在来自 DNS 服务器的回答中，回答区域包含了对最初请求的名字的资源记录。在回答报文中的回答区域中可以包含
多条 RR，因此一个主机名能够有多个 IP 地址。
+ 权威区域包含了其他权威服务器的记录。
+ 附加区域包含了其他有帮助的记录。   

2. **在 DNS 数据库中插入记录**    

加入我们想要注册一个 networkutopia.com 的域名，首先在注册登记机构注册域名 networkutopia.com。
注册登记机构是一个商业实体，它验证该域名的唯一性，将该域名输入 DNS 数据库。    

当我们向注册登记机构注册域名 networkutopia.com 时，需要向该机构提供你的基本和辅助权威 DNS 服务器的名字和
IP 地址。对于提供的每一个权威服务器，该注册机构确保将一个类型 NS 和一个类型 A 的记录输入 TLD com 服务器。    

话说权威服务器应该是可以搭建或者花钱存在别人的权威服务器里，但是这就得先要求权威服务器必须已经在
DNS 数据库中了。    

## 2.6  P2P 应用

### 2.6.1 P2P 文件分发

BitTorrent 是一种用于文件分发的流行 P2P 协议。用 BitTorrent 的术语来讲，参与一个特定文件
分发的所有对等方的集合被称为一个 **洪流**(torrent)。在一个洪流中的对等方彼此下载等长度
的文件块(chunk)，典型的块长度为 256KB。当一个对等方首次加入一个洪流时，它没有块。随着
时间的流逝，它累积了越来越多的块。当它下载块时，也为其他对等方上载了多个块。一旦某对等方获得
了整个文件，它也许离开洪流，或留在该洪流中并继续向其他对等方上载块。同时，任何对等方可能在
任何时刻仅具有块的子集就离开该洪流，并在以后重新加入该洪流中。    

每个洪流具有一个基础设施结点，称为 **追踪器**(tracker)。当一个对等方加入该洪流时，它向
追踪器注册自己，并周期性地通知该追踪器它仍在该洪流中。以这种方式，追踪器跟踪正参与在洪流
中的对等方。    

例如，当一个新的对等方 Alice 加入该洪流中，追踪器随机地从参与对等方的集合中选择一个对等方
的子集，并将这个子集中对等方的 IP 地址发送给 Alice。Alice持有对等方的这张列表，试图与该
列表上的所有对等方创建并行的 TCP 连接。我们称所有这样与 Alice 成功地创建一个 TCP 连接的
对等方为“邻近对等方”。随着时间的流逝，这些对等方中的某些可能离开，其他对等方可能试图与
Alice 创建 TCP 连接。     

在任何给定的时间，每个对等方将具有来自该文件1块子集，并且不同的对等方具有不同的子集。Alice
周期性地（经 TCP 连接）询问每个邻近对等方他们所具有的块列表。如果 Alice 具有 L 个不同的
邻居，她将获得 L 个块列表。有了这个信息，Alice 将对她当前还没有的块发出请求。    

因此在任何给定的时刻，Alice 将具有块的子集并知道它的邻居有哪些块。利用这些信息，Alice 将
做出两个重要决定。第一，她应当从她的邻居中请求哪些块。第二，她应当向哪些向她请求块的邻居发送。    

在决定请求哪些块的过程中，Alice 使用一种称为 **最稀缺优先** 的技术，这种技术的思路是，
针对她没有的块在她的邻居中决定最稀缺的块（最稀缺的块就是在她的邻居中副本数量最少的块），
并首先请求那些最稀缺的块。    

为了决定她响应哪个请求，BitTorrent 使用了一种机灵的对换算法。其基本想法是，Alice 根据当前
能够以最高速率向她提供数据的邻居，给出其优先权。特别是，Alice 对于她的每个邻居都持续地测量
接收到比特的速率，并确定以最高速率流入的 4 个邻居。每过 10 秒，她重新计算该速率并可能修改
这 4 个对等方的集合。每过 30 秒，她也要随机地选择另外一个邻居并向其发送块。我们将这个被
随机选择的对等方称为 Bob。除了这 5 个对等方的所有相邻对等方均被“阻塞”。     

### 2.6.2 分布式散列表

我们考虑在 P2P 网络中怎样实现一个简单的数据库。先从最简单的集中式版本开始，该数据库只
包含（键，值）对。我们用键来查询数据库。如果在该数据库中有一个或多个键——值对匹配该查询键，
该数据库就返回相应的值。    

之后考虑构建这种数据库的一个分布式、P2P 的版本，在数以百万计的对等方上存储（键，值）对。
在该 P2P 系统中，每个对等方将保持（键，值）对仅占总体的一个小子集。我们将允许任何对等方用
一个特别的键来查询该分布式数据库。分布式数据库则将定位该相应（键，值）对的对等方，然后向
查询的对等方返回该（键，值）对。任何对等方也将允许在数据库中插入新键——值对。这样一种
分布式数据库被称为 **分布式散列表**(Distributed Hash Table, DHT)。     

